/**
 * Minified by jsDelivr using Terser v5.10.0.
 * Original file: /npm/ol@6.12.0/renderer/canvas/TileLayer.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
var __extends=this&&this.__extends||function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();import CanvasLayerRenderer from"./Layer.js";import TileRange from"../../TileRange.js";import TileState from"../../TileState.js";import{IMAGE_SMOOTHING_DISABLED,IMAGE_SMOOTHING_ENABLED}from"./common.js";import{apply as applyTransform,compose as composeTransform,makeInverse}from"../../transform.js";import{assign}from"../../obj.js";import{createEmpty,equals,getIntersection,getTopLeft}from"../../extent.js";import{cssOpacity}from"../../css.js";import{fromUserExtent}from"../../proj.js";import{getUid}from"../../util.js";import{numberSafeCompareFunction}from"../../array.js";import{toString as toTransformString}from"../../transform.js";var CanvasTileLayerRenderer=function(e){function t(t){var r=e.call(this,t)||this;return r.extentChanged=!0,r.renderedExtent_=null,r.renderedPixelRatio,r.renderedProjection=null,r.renderedRevision,r.renderedTiles=[],r.newTiles_=!1,r.tmpExtent=createEmpty(),r.tmpTileRange_=new TileRange(0,0,0,0),r}return __extends(t,e),t.prototype.isDrawableTile=function(e){var t=this.getLayer(),r=e.getState(),i=t.getUseInterimTilesOnError();return r==TileState.LOADED||r==TileState.EMPTY||r==TileState.ERROR&&!i},t.prototype.getTile=function(e,t,r,i){var n=i.pixelRatio,o=i.viewState.projection,a=this.getLayer(),s=a.getSource().getTile(e,t,r,n,o);return s.getState()==TileState.ERROR&&(a.getUseInterimTilesOnError()?a.getPreload()>0&&(this.newTiles_=!0):s.setState(TileState.LOADED)),this.isDrawableTile(s)||(s=s.getInterimTile()),s},t.prototype.loadedTileCallback=function(t,r,i){return!!this.isDrawableTile(i)&&e.prototype.loadedTileCallback.call(this,t,r,i)},t.prototype.prepareFrame=function(e){return!!this.getLayer().getSource()},t.prototype.renderFrame=function(e,t){var r=e.layerStatesArray[e.layerIndex],i=e.viewState,n=i.projection,o=i.resolution,a=i.center,s=i.rotation,l=e.pixelRatio,d=this.getLayer(),p=d.getSource(),h=p.getRevision(),c=p.getTileGridForProjection(n),g=c.getZForResolution(o,p.zDirection),T=c.getResolution(g),m=e.extent,u=r.extent&&fromUserExtent(r.extent,n);u&&(m=getIntersection(m,fromUserExtent(r.extent,n)));var f=p.getTilePixelRatio(l),v=Math.round(e.size[0]*f),y=Math.round(e.size[1]*f);if(s){var x=Math.round(Math.sqrt(v*v+y*y));v=x,y=x}var R=T*v/2/f,E=T*y/2/f,S=[a[0]-R,a[1]-E,a[0]+R,a[1]+E],_=c.getTileRangeForExtentAndZ(m,g),C={};C[g]={};var w=this.createLoadedTileFinder(p,n,C),I=this.tmpExtent,j=this.tmpTileRange_;this.newTiles_=!1;for(var O=_.minX;O<=_.maxX;++O)for(var L=_.minY;L<=_.maxY;++L){var A=this.getTile(g,O,L,e);if(this.isDrawableTile(A)){var b=getUid(this);if(A.getState()==TileState.LOADED){C[g][A.tileCoord.toString()]=A;var D=A.inTransition(b);this.newTiles_||!D&&-1!==this.renderedTiles.indexOf(A)||(this.newTiles_=!0)}if(1===A.getAlpha(b,e.time))continue}var M=c.getTileCoordChildTileRange(A.tileCoord,j,I),P=!1;M&&(P=w(g+1,M)),P||c.forEachTileCoordParentTileRange(A.tileCoord,w,j,I)}var U=T/o;composeTransform(this.pixelTransform,e.size[0]/2,e.size[1]/2,1/f,1/f,s,-v/2,-y/2);var F=toTransformString(this.pixelTransform);this.useContainer(t,F,r.opacity,this.getBackground(e));var G=this.context,z=G.canvas;makeInverse(this.inversePixelTransform,this.pixelTransform),composeTransform(this.tempTransform,v/2,y/2,U,U,0,-v/2,-y/2),z.width!=v||z.height!=y?(z.width=v,z.height=y):this.containerReused||G.clearRect(0,0,v,y),u&&this.clipUnrotated(G,e,u),p.getInterpolate()||assign(G,IMAGE_SMOOTHING_DISABLED),this.preRender(G,e),this.renderedTiles.length=0;var N,k,q,B=Object.keys(C).map(Number);B.sort(numberSafeCompareFunction),1!==r.opacity||this.containerReused&&!p.getOpaque(e.viewState.projection)?(N=[],k=[]):B=B.reverse();for(var Y=B.length-1;Y>=0;--Y){var Z=B[Y],H=p.getTilePixelSize(Z,l,n),K=c.getResolution(Z)/T,X=H[0]*K*U,Q=H[1]*K*U,J=c.getTileCoordForCoordAndZ(getTopLeft(S),Z),V=c.getTileCoordExtent(J),W=applyTransform(this.tempTransform,[f*(V[0]-S[0])/T,f*(S[3]-V[3])/T]),$=f*p.getGutterForProjection(n),ee=C[Z];for(var te in ee){var re=(A=ee[te]).tileCoord,ie=J[1]-re[1],ne=Math.round(W[0]-(ie-1)*X),oe=J[2]-re[2],ae=Math.round(W[1]-(oe-1)*Q),se=ne-(O=Math.round(W[0]-ie*X)),le=ae-(L=Math.round(W[1]-oe*Q)),de=g===Z;if(!(D=de&&1!==A.getAlpha(getUid(this),e.time)))if(N){G.save(),q=[O,L,O+se,L,O+se,L+le,O,L+le];for(var pe=0,he=N.length;pe<he;++pe)if(g!==Z&&Z<k[pe]){var ce=N[pe];G.beginPath(),G.moveTo(q[0],q[1]),G.lineTo(q[2],q[3]),G.lineTo(q[4],q[5]),G.lineTo(q[6],q[7]),G.moveTo(ce[6],ce[7]),G.lineTo(ce[4],ce[5]),G.lineTo(ce[2],ce[3]),G.lineTo(ce[0],ce[1]),G.clip()}N.push(q),k.push(Z)}else G.clearRect(O,L,se,le);this.drawTileImage(A,e,O,L,se,le,$,de),N&&!D?(G.restore(),this.renderedTiles.unshift(A)):this.renderedTiles.push(A),this.updateUsedTiles(e.usedTiles,p,A)}}this.renderedRevision=h,this.renderedResolution=T,this.extentChanged=!this.renderedExtent_||!equals(this.renderedExtent_,S),this.renderedExtent_=S,this.renderedPixelRatio=l,this.renderedProjection=n,this.manageTilePyramid(e,p,c,l,n,m,g,d.getPreload()),this.scheduleExpireCache(e,p),this.postRender(G,e),r.extent&&G.restore(),assign(G,IMAGE_SMOOTHING_ENABLED),F!==z.style.transform&&(z.style.transform=F);var ge=cssOpacity(r.opacity),Te=this.container;return ge!==Te.style.opacity&&(Te.style.opacity=ge),this.container},t.prototype.drawTileImage=function(e,t,r,i,n,o,a,s){var l=this.getTileImage(e);if(l){var d=getUid(this),p=s?e.getAlpha(d,t.time):1,h=p!==this.context.globalAlpha;h&&(this.context.save(),this.context.globalAlpha=p),this.context.drawImage(l,a,a,l.width-2*a,l.height-2*a,r,i,n,o),h&&this.context.restore(),1!==p?t.animate=!0:s&&e.endTransition(d)}},t.prototype.getImage=function(){var e=this.context;return e?e.canvas:null},t.prototype.getTileImage=function(e){return e.getImage()},t.prototype.scheduleExpireCache=function(e,t){if(t.canExpireCache()){var r=function(e,t,r){var i=getUid(e);i in r.usedTiles&&e.expireCache(r.viewState.projection,r.usedTiles[i])}.bind(null,t);e.postRenderFunctions.push(r)}},t.prototype.updateUsedTiles=function(e,t,r){var i=getUid(t);i in e||(e[i]={}),e[i][r.getKey()]=!0},t.prototype.manageTilePyramid=function(e,t,r,i,n,o,a,s,l){var d=getUid(t);d in e.wantedTiles||(e.wantedTiles[d]={});var p,h,c,g,T,m,u=e.wantedTiles[d],f=e.tileQueue,v=0;for(m=r.getMinZoom();m<=a;++m)for(h=r.getTileRangeForExtentAndZ(o,m,h),c=r.getResolution(m),g=h.minX;g<=h.maxX;++g)for(T=h.minY;T<=h.maxY;++T)a-m<=s?(++v,(p=t.getTile(m,g,T,i,n)).getState()==TileState.IDLE&&(u[p.getKey()]=!0,f.isKeyQueued(p.getKey())||f.enqueue([p,d,r.getTileCoordCenter(p.tileCoord),c])),void 0!==l&&l(p)):t.useTile(m,g,T,n);t.updateCacheSize(v,n)},t}(CanvasLayerRenderer);CanvasTileLayerRenderer.prototype.getLayer;export default CanvasTileLayerRenderer;
//# sourceMappingURL=/sm/551e39e5a3a8d37fa484c75943133ed95daf0d13a92a998337d34265ff7792d6.map