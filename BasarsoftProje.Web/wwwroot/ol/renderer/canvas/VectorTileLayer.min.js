/**
 * Minified by jsDelivr using Terser v5.10.0.
 * Original file: /npm/ol@6.12.0/renderer/canvas/VectorTileLayer.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
var __extends=this&&this.__extends||function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function o(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(o.prototype=r.prototype,new o)}}();import CanvasBuilderGroup from"../../render/canvas/BuilderGroup.js";import CanvasExecutorGroup from"../../render/canvas/ExecutorGroup.js";import CanvasTileLayerRenderer from"./TileLayer.js";import ReplayType from"../../render/canvas/BuilderType.js";import TileState from"../../TileState.js";import VectorTileRenderType from"../../layer/VectorTileRenderType.js";import ViewHint from"../../ViewHint.js";import{HIT_DETECT_RESOLUTION,createHitDetectionImageData,hitDetect}from"../../render/canvas/hitdetect.js";import{apply as applyTransform,create as createTransform,multiply,reset as resetTransform,scale,scale as scaleTransform,translate as translateTransform}from"../../transform.js";import{boundingExtent,buffer,containsExtent,equals,getIntersection,getTopLeft,intersects}from"../../extent.js";import{getSquaredTolerance as getSquaredRenderTolerance,renderFeature}from"../vector.js";import{getUid}from"../../util.js";import{toSize}from"../../size.js";import{wrapX}from"../../coordinate.js";var IMAGE_REPLAYS={image:[ReplayType.POLYGON,ReplayType.CIRCLE,ReplayType.LINE_STRING,ReplayType.IMAGE,ReplayType.TEXT],hybrid:[ReplayType.POLYGON,ReplayType.LINE_STRING],vector:[]},VECTOR_REPLAYS={hybrid:[ReplayType.IMAGE,ReplayType.TEXT,ReplayType.DEFAULT],vector:[ReplayType.POLYGON,ReplayType.CIRCLE,ReplayType.LINE_STRING,ReplayType.IMAGE,ReplayType.TEXT,ReplayType.DEFAULT]},CanvasVectorTileLayerRenderer=function(e){function t(t){var r=e.call(this,t)||this;return r.boundHandleStyleImageChange_=r.handleStyleImageChange_.bind(r),r.dirty_=!1,r.renderedLayerRevision_,r.renderedPixelToCoordinateTransform_=null,r.renderedRotation_,r.tmpTransform_=createTransform(),r}return __extends(t,e),t.prototype.prepareTile=function(e,t,r){var o,i=e.getState();return i!==TileState.LOADED&&i!==TileState.ERROR||(this.updateExecutorGroup_(e,t,r),this.tileImageNeedsRender_(e)&&(o=!0)),o},t.prototype.getTile=function(t,r,o,i){var n=i.pixelRatio,a=i.viewState,l=a.resolution,s=a.projection,d=this.getLayer(),p=d.getSource().getTile(t,r,o,n,s),u=i.viewHints,T=!(u[ViewHint.ANIMATING]||u[ViewHint.INTERACTING]);return!T&&p.wantedResolution||(p.wantedResolution=l),this.prepareTile(p,n,s)&&(T||Date.now()-i.time<8)&&d.getRenderMode()!==VectorTileRenderType.VECTOR&&this.renderTileImage_(p,i),e.prototype.getTile.call(this,t,r,o,i)},t.prototype.isDrawableTile=function(t){var r=this.getLayer();return e.prototype.isDrawableTile.call(this,t)&&(r.getRenderMode()===VectorTileRenderType.VECTOR?getUid(r)in t.executorGroups:t.hasContext(r))},t.prototype.getTileImage=function(e){return e.getImage(this.getLayer())},t.prototype.prepareFrame=function(t){var r=this.getLayer().getRevision();return this.renderedLayerRevision_!=r&&(this.renderedTiles.length=0),this.renderedLayerRevision_=r,e.prototype.prepareFrame.call(this,t)},t.prototype.updateExecutorGroup_=function(e,t,r){var o=this.getLayer(),i=o.getRevision(),n=o.getRenderOrder()||null,a=e.wantedResolution,l=e.getReplayState(o);if(l.dirty||l.renderedResolution!==a||l.renderedRevision!=i||l.renderedRenderOrder!=n){var s=o.getSource(),d=o.getDeclutter(),p=s.getTileGrid(),u=s.getTileGridForProjection(r).getTileCoordExtent(e.wrappedTileCoord),T=s.getSourceTiles(t,r,e),c=getUid(o);delete e.hitDetectionImageData[c],e.executorGroups[c]=[],d&&(e.declutterExecutorGroups[c]=[]);for(var g=function(r,i){var g=T[r];if(g.getState()!=TileState.LOADED)return"continue";var y=g.tileCoord,h=p.getTileCoordExtent(y),v=getIntersection(u,h),R=buffer(v,o.getRenderBuffer()*a,f.tmpExtent),m=equals(h,v)?null:R;l.dirty=!1;var E=new CanvasBuilderGroup(0,R,a,t),C=d?new CanvasBuilderGroup(0,v,a,t):void 0,S=getSquaredRenderTolerance(a,t),x=function(e){var t,r=e.getStyleFunction()||o.getStyleFunction();if(r&&(t=r(e,a)),t){var i=this.renderFeature(e,S,t,E,C);this.dirty_=this.dirty_||i,l.dirty=l.dirty||i}},_=g.getFeatures();n&&n!==l.renderedRenderOrder&&_.sort(n);for(var I=0,w=_.length;I<w;++I){var L=_[I];m&&!intersects(m,L.getGeometry().getExtent())||x.call(f,L)}var G=E.finish(),O=o.getRenderMode()!==VectorTileRenderType.VECTOR&&d&&1===T.length?null:v,A=new CanvasExecutorGroup(O,a,t,s.getOverlaps(),G,o.getRenderBuffer());if(e.executorGroups[c].push(A),C){var D=new CanvasExecutorGroup(null,a,t,s.getOverlaps(),C.finish(),o.getRenderBuffer());e.declutterExecutorGroups[c].push(D)}},f=this,y=0,h=T.length;y<h;++y)g(y);l.renderedRevision=i,l.renderedRenderOrder=n,l.renderedResolution=a}},t.prototype.forEachFeatureAtCoordinate=function(e,t,r,o,i){var n=t.viewState.resolution,a=t.viewState.rotation;r=null==r?0:r;var l=this.getLayer(),s=l.getSource().getTileGridForProjection(t.viewState.projection),d=boundingExtent([e]);buffer(d,n*r,d);for(var p,u={},T=function(e,t,r){var n=e.getId();void 0===n&&(n=getUid(e));var a=u[n];if(a){if(!0!==a&&r<a.distanceSq){if(0===r)return u[n]=!0,i.splice(i.lastIndexOf(a),1),o(e,l,t);a.geometry=t,a.distanceSq=r}}else{if(0===r)return u[n]=!0,o(e,l,t);i.push(u[n]={feature:e,layer:l,geometry:t,distanceSq:r,callback:o})}},c=this.renderedTiles,g=function(o,i){var u=c[o],g=s.getTileCoordExtent(u.wrappedTileCoord);if(!intersects(g,d))return"continue";var f=getUid(l),y=[u.executorGroups[f]],h=u.declutterExecutorGroups[f];h&&y.push(h),y.some((function(o){for(var i=o===h?t.declutterTree.all().map((function(e){return e.value})):null,l=0,s=o.length;l<s;++l){var d=o[l];if(p=d.forEachFeatureAtCoordinate(e,n,a,r,T,i))return!0}}))},f=0,y=c.length;!p&&f<y;++f)g(f);return p},t.prototype.getFeatures=function(e){return new Promise(function(t,r){for(var o,i=this.getLayer(),n=getUid(i),a=i.getSource(),l=this.renderedProjection,s=l.getExtent(),d=this.renderedResolution,p=a.getTileGridForProjection(l),u=applyTransform(this.renderedPixelToCoordinateTransform_,e.slice()),T=p.getTileCoordForCoordAndResolution(u,d),c=0,g=this.renderedTiles.length;c<g;++c)if(T.toString()===this.renderedTiles[c].tileCoord.toString()){if((o=this.renderedTiles[c]).getState()===TileState.LOADED){var f=p.getTileCoordExtent(o.tileCoord);a.getWrapX()&&l.canWrapX()&&!containsExtent(s,f)&&wrapX(u,l);break}o=void 0}if(!o||o.loadingSourceTiles>0)t([]);else{var y=p.getTileCoordExtent(o.wrappedTileCoord),h=getTopLeft(y),v=[(u[0]-h[0])/d,(h[1]-u[1])/d],R=o.getSourceTiles().reduce((function(e,t){return e.concat(t.getFeatures())}),[]),m=o.hitDetectionImageData[n];if(!m&&!this.animatingOrInteracting_){var E=toSize(p.getTileSize(p.getZForResolution(d))),C=this.renderedRotation_,S=[this.getRenderTransform(p.getTileCoordCenter(o.wrappedTileCoord),d,0,HIT_DETECT_RESOLUTION,E[0]*HIT_DETECT_RESOLUTION,E[1]*HIT_DETECT_RESOLUTION,0)];m=createHitDetectionImageData(E,S,R,i.getStyleFunction(),p.getTileCoordExtent(o.wrappedTileCoord),o.getReplayState(i).renderedResolution,C),o.hitDetectionImageData[n]=m}t(hitDetect(v,R,m))}}.bind(this))},t.prototype.handleFontsChanged=function(){var e=this.getLayer();e.getVisible()&&void 0!==this.renderedLayerRevision_&&e.changed()},t.prototype.handleStyleImageChange_=function(e){this.renderIfReadyAndVisible()},t.prototype.renderDeclutter=function(e){var t=this.context,r=t.globalAlpha;t.globalAlpha=this.getLayer().getOpacity();for(var o=e.viewHints,i=!(o[ViewHint.ANIMATING]||o[ViewHint.INTERACTING]),n=this.renderedTiles,a=0,l=n.length;a<l;++a){var s=n[a],d=s.declutterExecutorGroups[getUid(this.getLayer())];if(d)for(var p=d.length-1;p>=0;--p)d[p].execute(this.context,1,this.getTileRenderTransform(s,e),e.viewState.rotation,i,void 0,e.declutterTree)}t.globalAlpha=r},t.prototype.getTileRenderTransform=function(e,t){var r=t.pixelRatio,o=t.viewState,i=o.center,n=o.resolution,a=o.rotation,l=t.size,s=Math.round(l[0]*r),d=Math.round(l[1]*r),p=this.getLayer().getSource().getTileGridForProjection(t.viewState.projection),u=e.tileCoord,T=p.getTileCoordExtent(e.wrappedTileCoord),c=p.getTileCoordExtent(u,this.tmpExtent)[0]-T[0];return multiply(scale(this.inversePixelTransform.slice(),1/r,1/r),this.getRenderTransform(i,n,a,r,s,d,c))},t.prototype.renderFrame=function(t,r){var o=t.viewHints,i=!(o[ViewHint.ANIMATING]||o[ViewHint.INTERACTING]);e.prototype.renderFrame.call(this,t,r),this.renderedPixelToCoordinateTransform_=t.pixelToCoordinateTransform.slice(),this.renderedRotation_=t.viewState.rotation;var n=this.getLayer(),a=n.getRenderMode(),l=this.context,s=l.globalAlpha;l.globalAlpha=n.getOpacity();for(var d=VECTOR_REPLAYS[a],p=t.viewState.rotation,u=this.renderedTiles,T=[],c=[],g=u.length-1;g>=0;--g)for(var f=u[g],y=this.getTileRenderTransform(f,t),h=f.executorGroups[getUid(n)],v=!1,R=0,m=h.length;R<m;++R){var E=h[R];if(E.hasExecutors(d)){var C=f.tileCoord[0],S=void 0;if(!v&&(S=E.getClipCoords(y))){l.save();for(var x=0,_=T.length;x<_;++x){var I=T[x];C<c[x]&&(l.beginPath(),l.moveTo(S[0],S[1]),l.lineTo(S[2],S[3]),l.lineTo(S[4],S[5]),l.lineTo(S[6],S[7]),l.moveTo(I[6],I[7]),l.lineTo(I[4],I[5]),l.lineTo(I[2],I[3]),l.lineTo(I[0],I[1]),l.clip())}}E.execute(l,1,y,p,i,d),!v&&S&&(l.restore(),T.push(S),c.push(C),v=!0)}}return l.globalAlpha=s,this.container},t.prototype.renderFeature=function(e,t,r,o,i){if(!r)return!1;var n=!1;if(Array.isArray(r))for(var a=0,l=r.length;a<l;++a)n=renderFeature(o,e,r[a],t,this.boundHandleStyleImageChange_,void 0,i)||n;else n=renderFeature(o,e,r,t,this.boundHandleStyleImageChange_,void 0,i);return n},t.prototype.tileImageNeedsRender_=function(e){var t=this.getLayer();if(t.getRenderMode()===VectorTileRenderType.VECTOR)return!1;var r=e.getReplayState(t),o=t.getRevision(),i=e.wantedResolution;return r.renderedTileResolution!==i||r.renderedTileRevision!==o},t.prototype.renderTileImage_=function(e,t){var r=this.getLayer(),o=e.getReplayState(r),i=r.getRevision(),n=e.executorGroups[getUid(r)];o.renderedTileRevision=i;var a=e.wrappedTileCoord,l=a[0],s=r.getSource(),d=t.pixelRatio,p=t.viewState.projection,u=s.getTileGridForProjection(p),T=u.getResolution(e.tileCoord[0]),c=t.pixelRatio/e.wantedResolution*T,g=u.getResolution(l),f=e.getContext(r);d=Math.round(Math.max(d,c/d));var y=s.getTilePixelSize(l,d,p);f.canvas.width=y[0],f.canvas.height=y[1];var h=d/c;if(1!==h){var v=resetTransform(this.tmpTransform_);scaleTransform(v,h,h),f.setTransform.apply(f,v)}var R=u.getTileCoordExtent(a,this.tmpExtent),m=c/g,E=resetTransform(this.tmpTransform_);scaleTransform(E,m,-m),translateTransform(E,-R[0],-R[3]);for(var C=0,S=n.length;C<S;++C){n[C].execute(f,h,E,0,!0,IMAGE_REPLAYS[r.getRenderMode()])}o.renderedTileResolution=e.wantedResolution},t}(CanvasTileLayerRenderer);export default CanvasVectorTileLayerRenderer;
//# sourceMappingURL=/sm/a1008935d457491e7071f9ef51a8bbeda27af0a6bf1aafc4cc1ee340e96de442.map