/**
 * Minified by jsDelivr using Terser v5.10.0.
 * Original file: /npm/ol@6.12.0/renderer/webgl/TileLayer.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
var __extends=this&&this.__extends||function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();import LRUCache from"../../structs/LRUCache.js";import State from"../../source/State.js";import TileRange from"../../TileRange.js";import TileState from"../../TileState.js";import TileTexture from"../../webgl/TileTexture.js";import WebGLArrayBuffer from"../../webgl/Buffer.js";import WebGLLayerRenderer from"./Layer.js";import{AttributeType}from"../../webgl/Helper.js";import{ELEMENT_ARRAY_BUFFER,STATIC_DRAW}from"../../webgl.js";import{compose as composeTransform,create as createTransform}from"../../transform.js";import{create as createMat4,fromTransform as mat4FromTransform}from"../../vec/mat4.js";import{createOrUpdate as createTileCoord,getKeyZXY,getKey as getTileCoordKey}from"../../tilecoord.js";import{fromUserExtent}from"../../proj.js";import{getIntersection}from"../../extent.js";import{getUid}from"../../util.js";import{isEmpty}from"../../extent.js";import{numberSafeCompareFunction}from"../../array.js";import{toSize}from"../../size.js";export var Uniforms={TILE_TEXTURE_ARRAY:"u_tileTextures",TILE_TRANSFORM:"u_tileTransform",TRANSITION_ALPHA:"u_transitionAlpha",DEPTH:"u_depth",TEXTURE_PIXEL_WIDTH:"u_texturePixelWidth",TEXTURE_PIXEL_HEIGHT:"u_texturePixelHeight",RESOLUTION:"u_resolution",ZOOM:"u_zoom"};export var Attributes={TEXTURE_COORD:"a_textureCoord"};var attributeDescriptions=[{name:Attributes.TEXTURE_COORD,size:2,type:AttributeType.FLOAT}],empty={};function depthForZ(e){return 2*(1-1/(e+1))-1}function addTileTextureToLookup(e,t,r){r in e||(e[r]=[]),e[r].push(t)}function getRenderExtent(e,t){var r=e.layerStatesArray[e.layerIndex];r.extent&&(t=getIntersection(t,fromUserExtent(r.extent,e.viewState.projection)));var i=r.layer.getSource();if(!i.getWrapX()){var o=i.getTileGridForProjection(e.viewState.projection).getExtent();o&&(t=getIntersection(t,o))}return t}var WebGLTileLayerRenderer=function(e){function t(t,r){var i=e.call(this,t,{uniforms:r.uniforms})||this;i.tileTransform_=createTransform(),i.tempMat4_=createMat4(),i.tempTileRange_=new TileRange(0,0,0,0),i.tempTileCoord_=createTileCoord(0,0,0),i.tempSize_=[0,0],i.program_,i.vertexShader_=r.vertexShader,i.fragmentShader_=r.fragmentShader,i.indices_=new WebGLArrayBuffer(ELEMENT_ARRAY_BUFFER,STATIC_DRAW),i.indices_.fromArray([0,1,3,1,2,3]);var o=void 0!==r.cacheSize?r.cacheSize:512;return i.tileTextureCache_=new LRUCache(o),i.paletteTextures_=r.paletteTextures||[],i}return __extends(t,e),t.prototype.reset=function(t){e.prototype.reset.call(this,{uniforms:t.uniforms}),this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.paletteTextures_=t.paletteTextures||[],this.helper&&(this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_))},t.prototype.afterHelperCreated=function(){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.helper.flushBufferData(this.indices_)},t.prototype.isDrawableTile_=function(e){var t=this.getLayer(),r=e.getState(),i=t.getUseInterimTilesOnError();return r==TileState.LOADED||r==TileState.EMPTY||r==TileState.ERROR&&!i},t.prototype.prepareFrameInternal=function(e){var t=this.getLayer().getSource();return!!t&&(!isEmpty(getRenderExtent(e,e.extent))&&t.getState()===State.READY)},t.prototype.enqueueTiles=function(e,t,r,i){var o=e.viewState,n=this.getLayer().getSource(),a=n.getTileGridForProjection(o.projection),s=this.tileTextureCache_,l=a.getTileRangeForExtentAndZ(t,r,this.tempTileRange_),p=getUid(n);p in e.wantedTiles||(e.wantedTiles[p]={});for(var u=e.wantedTiles[p],T=a.getResolution(r),h=l.minX;h<=l.maxX;++h)for(var m=l.minY;m<=l.maxY;++m){var f=createTileCoord(r,h,m,this.tempTileCoord_),c=getTileCoordKey(f),d=void 0,g=void 0;if(s.containsKey(c)&&(g=(d=s.get(c)).tile),!d||d.tile.key!==n.getKey())if(g=n.getTile(r,h,m,e.pixelRatio,o.projection),d)if(this.isDrawableTile_(g))d.setTile(g);else{var _=g.getInterimTile();d.setTile(_)}else d=new TileTexture(g,a,this.helper),s.set(c,d);addTileTextureToLookup(i,d,r);var x=g.getKey();u[x]=!0,g.getState()===TileState.IDLE&&(e.tileQueue.isKeyQueued(x)||e.tileQueue.enqueue([g,p,a.getTileCoordCenter(f),T]))}},t.prototype.renderFrame=function(e){var t=this.helper.getGL();this.preRender(t,e);var r=e.viewState,i=this.getLayer().getSource(),o=i.getTileGridForProjection(r.projection),n=getRenderExtent(e,e.extent),a=o.getZForResolution(r.resolution,i.zDirection),s={};if(e.nextExtent){var l=o.getZForResolution(r.nextResolution,i.zDirection),p=getRenderExtent(e,e.nextExtent);this.enqueueTiles(e,p,l,s)}this.enqueueTiles(e,n,a,s);for(var u={},T=getUid(this),h=e.time,m=!1,f=s[a],c=0,d=f.length;c<d;++c){var g=(w=(B=f[c]).tile).tileCoord;if(B.loaded){if(1===(D=w.getAlpha(T,h))){w.endTransition(T);continue}m=!0,u[X=getTileCoordKey(g)]=D}if(!this.findAltTiles_(o,g,a+1,s))for(var _=o.getMinZoom(),x=a-1;x>=_;--x){if(this.findAltTiles_(o,g,x,s))break}}this.helper.useProgram(this.program_),this.helper.prepareDraw(e,!m);for(var E=Object.keys(s).map(Number).sort(numberSafeCompareFunction),R=r.center[0],v=r.center[1],y=0,S=E.length;y<S;++y){var L=E[y],U=o.getResolution(L),A=toSize(o.getTileSize(L),this.tempSize_),C=o.getOrigin(L),b=(R-C[0])/(A[0]*U),j=(C[1]-v)/(A[1]*U),I=r.resolution/U,F=depthForZ(L),O=s[L];for(c=0,d=O.length;c<d;++c){if((B=O[c]).loaded){g=(w=B.tile).tileCoord;var w,D,X=getTileCoordKey(g),P=g[1],z=g[2];composeTransform(this.tileTransform_,0,0,2/(e.size[0]*I/A[0]),-2/(e.size[1]*I/A[1]),r.rotation,-(b-P),-(j-z)),this.helper.setUniformMatrixValue(Uniforms.TILE_TRANSFORM,mat4FromTransform(this.tempMat4_,this.tileTransform_)),this.helper.bindBuffer(B.coords),this.helper.bindBuffer(this.indices_),this.helper.enableAttributes(attributeDescriptions);for(var G=0;G<B.textures.length;){var H="TEXTURE"+G,M=Uniforms.TILE_TEXTURE_ARRAY+"["+G+"]";t.activeTexture(t[H]),t.bindTexture(t.TEXTURE_2D,B.textures[G]),t.uniform1i(this.helper.getUniformLocation(M),G),++G}for(var W=0;W<this.paletteTextures_.length;++W){var K=this.paletteTextures_[W];t.activeTexture(t["TEXTURE"+G]);var Y=K.getTexture(t);t.bindTexture(t.TEXTURE_2D,Y),t.uniform1i(this.helper.getUniformLocation(K.name),G),++G}(D=X in u?u[X]:1)<1&&(e.animate=!0),this.helper.setUniformFloatValue(Uniforms.TRANSITION_ALPHA,D),this.helper.setUniformFloatValue(Uniforms.DEPTH,F),this.helper.setUniformFloatValue(Uniforms.TEXTURE_PIXEL_WIDTH,A[0]),this.helper.setUniformFloatValue(Uniforms.TEXTURE_PIXEL_HEIGHT,A[1]),this.helper.setUniformFloatValue(Uniforms.RESOLUTION,r.resolution),this.helper.setUniformFloatValue(Uniforms.ZOOM,r.zoom),this.helper.drawElements(0,this.indices_.getSize())}}}this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);for(var N=this.helper.getCanvas(),Z=this.tileTextureCache_;Z.canExpireCache();){var B;(B=Z.pop()).dispose()}return e.postRenderFunctions.push((function(e,t){i.expireCache(t.viewState.projection,empty)})),this.postRender(t,e),N},t.prototype.findAltTiles_=function(e,t,r,i){var o=e.getTileRangeForTileCoordAndZ(t,r,this.tempTileRange_);if(!o)return!1;for(var n=!0,a=this.tileTextureCache_,s=o.minX;s<=o.maxX;++s)for(var l=o.minY;l<=o.maxY;++l){var p=getKeyZXY(r,s,l),u=!1;if(a.containsKey(p)){var T=a.get(p);T.loaded&&(addTileTextureToLookup(i,T,r),u=!0)}u||(n=!1)}return n},t.prototype.disposeInternal=function(){var t=this.helper,r=t.getGL();t.deleteBuffer(this.indices_),delete this.indices_,r.deleteProgram(this.program_),delete this.program_;var i=this.tileTextureCache_;i.forEach((function(e){e.dispose()})),i.clear(),delete this.tileTextureCache_,e.prototype.disposeInternal.call(this)},t}(WebGLLayerRenderer);WebGLTileLayerRenderer.prototype.getLayer;export default WebGLTileLayerRenderer;
//# sourceMappingURL=/sm/60c2b28abe6803079125fd075db0821bba3d77b289fd1268d72306978f523b08.map