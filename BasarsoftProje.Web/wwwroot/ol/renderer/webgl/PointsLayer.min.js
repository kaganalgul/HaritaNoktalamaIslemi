/**
 * Minified by jsDelivr using Terser v5.10.0.
 * Original file: /npm/ol@6.12.0/renderer/webgl/PointsLayer.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
var __extends=this&&this.__extends||function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();import BaseVector from"../../layer/BaseVector.js";import GeometryType from"../../geom/GeometryType.js";import VectorEventType from"../../source/VectorEventType.js";import ViewHint from"../../ViewHint.js";import WebGLArrayBuffer from"../../webgl/Buffer.js";import WebGLLayerRenderer,{WebGLWorkerMessageType,colorDecodeId,colorEncodeId}from"./Layer.js";import WebGLRenderTarget from"../../webgl/RenderTarget.js";import{ARRAY_BUFFER,DYNAMIC_DRAW,ELEMENT_ARRAY_BUFFER}from"../../webgl.js";import{AttributeType,DefaultUniform}from"../../webgl/Helper.js";import{apply as applyTransform,create as createTransform,makeInverse as makeInverseTransform,multiply as multiplyTransform}from"../../transform.js";import{assert}from"../../asserts.js";import{buffer,createEmpty,equals}from"../../extent.js";import{create as createWebGLWorker}from"../../worker/webgl.js";import{getUid}from"../../util.js";import{listen,unlistenByKey}from"../../events.js";var WebGLPointsLayerRenderer=function(e){function t(t,r){var i=this,s=r.uniforms||{},n=createTransform();s[DefaultUniform.PROJECTION_MATRIX]=n,(i=e.call(this,t,{uniforms:s,postProcesses:r.postProcesses})||this).sourceRevision_=-1,i.verticesBuffer_=new WebGLArrayBuffer(ARRAY_BUFFER,DYNAMIC_DRAW),i.hitVerticesBuffer_=new WebGLArrayBuffer(ARRAY_BUFFER,DYNAMIC_DRAW),i.indicesBuffer_=new WebGLArrayBuffer(ELEMENT_ARRAY_BUFFER,DYNAMIC_DRAW),i.vertexShader_=r.vertexShader,i.fragmentShader_=r.fragmentShader,i.program_,i.hitDetectionEnabled_=!(!r.hitFragmentShader||!r.hitVertexShader),i.hitVertexShader_=r.hitVertexShader,i.hitFragmentShader_=r.hitFragmentShader,i.hitProgram_;var o=r.attributes?r.attributes.map((function(e){return{name:"a_"+e.name,size:1,type:AttributeType.FLOAT}})):[];i.attributes=[{name:"a_position",size:2,type:AttributeType.FLOAT},{name:"a_index",size:1,type:AttributeType.FLOAT}].concat(o),i.hitDetectionAttributes=[{name:"a_position",size:2,type:AttributeType.FLOAT},{name:"a_index",size:1,type:AttributeType.FLOAT},{name:"a_hitColor",size:4,type:AttributeType.FLOAT},{name:"a_featureUid",size:1,type:AttributeType.FLOAT}].concat(o),i.customAttributes=r.attributes?r.attributes:[],i.previousExtent_=createEmpty(),i.currentTransform_=n,i.renderTransform_=createTransform(),i.invertRenderTransform_=createTransform(),i.renderInstructions_=new Float32Array(0),i.hitRenderInstructions_=new Float32Array(0),i.hitRenderTarget_,i.worker_=createWebGLWorker(),i.worker_.addEventListener("message",function(e){var t=e.data;if(t.type===WebGLWorkerMessageType.GENERATE_BUFFERS){var r=t.projectionTransform;t.hitDetection?(this.hitVerticesBuffer_.fromArrayBuffer(t.vertexBuffer),this.helper.flushBufferData(this.hitVerticesBuffer_)):(this.verticesBuffer_.fromArrayBuffer(t.vertexBuffer),this.helper.flushBufferData(this.verticesBuffer_)),this.indicesBuffer_.fromArrayBuffer(t.indexBuffer),this.helper.flushBufferData(this.indicesBuffer_),this.renderTransform_=r,makeInverseTransform(this.invertRenderTransform_,this.renderTransform_),t.hitDetection?this.hitRenderInstructions_=new Float32Array(e.data.renderInstructions):this.renderInstructions_=new Float32Array(e.data.renderInstructions),this.getLayer().changed()}}.bind(i)),i.featureCache_={},i.featureCount_=0;var a=i.getLayer().getSource();return i.sourceListenKeys_=[listen(a,VectorEventType.ADDFEATURE,i.handleSourceFeatureAdded_,i),listen(a,VectorEventType.CHANGEFEATURE,i.handleSourceFeatureChanged_,i),listen(a,VectorEventType.REMOVEFEATURE,i.handleSourceFeatureDelete_,i),listen(a,VectorEventType.CLEAR,i.handleSourceFeatureClear_,i)],a.forEachFeature(function(e){this.featureCache_[getUid(e)]={feature:e,properties:e.getProperties(),geometry:e.getGeometry()},this.featureCount_++}.bind(i)),i}return __extends(t,e),t.prototype.afterHelperCreated=function(){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.hitDetectionEnabled_&&(this.hitProgram_=this.helper.getProgram(this.hitFragmentShader_,this.hitVertexShader_),this.hitRenderTarget_=new WebGLRenderTarget(this.helper))},t.prototype.handleSourceFeatureAdded_=function(e){var t=e.feature;this.featureCache_[getUid(t)]={feature:t,properties:t.getProperties(),geometry:t.getGeometry()},this.featureCount_++},t.prototype.handleSourceFeatureChanged_=function(e){var t=e.feature;this.featureCache_[getUid(t)]={feature:t,properties:t.getProperties(),geometry:t.getGeometry()}},t.prototype.handleSourceFeatureDelete_=function(e){var t=e.feature;delete this.featureCache_[getUid(t)],this.featureCount_--},t.prototype.handleSourceFeatureClear_=function(){this.featureCache_={},this.featureCount_=0},t.prototype.renderFrame=function(e){var t=this.helper.getGL();this.preRender(t,e);var r=this.indicesBuffer_.getSize();this.helper.drawElements(0,r),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);var i=this.helper.getCanvas();return this.hitDetectionEnabled_&&(this.renderHitDetection(e),this.hitRenderTarget_.clearCachedData()),this.postRender(t,e),i},t.prototype.prepareFrameInternal=function(e){var t=this.getLayer(),r=t.getSource(),i=e.viewState,s=!e.viewHints[ViewHint.ANIMATING]&&!e.viewHints[ViewHint.INTERACTING],n=!equals(this.previousExtent_,e.extent),o=this.sourceRevision_<r.getRevision();if(o&&(this.sourceRevision_=r.getRevision()),s&&(n||o)){var a=i.projection,h=i.resolution,u=t instanceof BaseVector?t.getRenderBuffer():0,f=buffer(e.extent,u*h);r.loadFeatures(f,h,a),this.rebuildBuffers_(e),this.previousExtent_=e.extent.slice()}return this.helper.makeProjectionTransform(e,this.currentTransform_),multiplyTransform(this.currentTransform_,this.invertRenderTransform_),this.helper.useProgram(this.program_),this.helper.prepareDraw(e),this.helper.bindBuffer(this.verticesBuffer_),this.helper.bindBuffer(this.indicesBuffer_),this.helper.enableAttributes(this.attributes),!0},t.prototype.rebuildBuffers_=function(e){var t=createTransform();this.helper.makeProjectionTransform(e,t);var r,i,s=(2+this.customAttributes.length)*this.featureCount_;if(this.renderInstructions_&&this.renderInstructions_.length===s||(this.renderInstructions_=new Float32Array(s)),this.hitDetectionEnabled_){var n=(7+this.customAttributes.length)*this.featureCount_;this.hitRenderInstructions_&&this.hitRenderInstructions_.length===n||(this.hitRenderInstructions_=new Float32Array(n))}var o,a=[],h=[],u=0,f=0;for(var c in this.featureCache_)if((i=(r=this.featureCache_[c]).geometry)&&i.getType()===GeometryType.POINT){a[0]=i.getFlatCoordinates()[0],a[1]=i.getFlatCoordinates()[1],applyTransform(t,a),o=colorEncodeId(f+6,h),this.renderInstructions_[u++]=a[0],this.renderInstructions_[u++]=a[1],this.hitDetectionEnabled_&&(this.hitRenderInstructions_[f++]=a[0],this.hitRenderInstructions_[f++]=a[1],this.hitRenderInstructions_[f++]=o[0],this.hitRenderInstructions_[f++]=o[1],this.hitRenderInstructions_[f++]=o[2],this.hitRenderInstructions_[f++]=o[3],this.hitRenderInstructions_[f++]=Number(c));for(var p=void 0,d=0;d<this.customAttributes.length;d++)p=this.customAttributes[d].callback(r.feature,r.properties),this.renderInstructions_[u++]=p,this.hitDetectionEnabled_&&(this.hitRenderInstructions_[f++]=p)}var _={type:WebGLWorkerMessageType.GENERATE_BUFFERS,renderInstructions:this.renderInstructions_.buffer,customAttributesCount:this.customAttributes.length};if(_.projectionTransform=t,this.worker_.postMessage(_,[this.renderInstructions_.buffer]),this.renderInstructions_=null,this.hitDetectionEnabled_){var l={type:WebGLWorkerMessageType.GENERATE_BUFFERS,renderInstructions:this.hitRenderInstructions_.buffer,customAttributesCount:5+this.customAttributes.length};l.projectionTransform=t,l.hitDetection=!0,this.worker_.postMessage(l,[this.hitRenderInstructions_.buffer]),this.hitRenderInstructions_=null}},t.prototype.forEachFeatureAtCoordinate=function(e,t,r,i,s){if(assert(this.hitDetectionEnabled_,66),this.hitRenderInstructions_){var n=applyTransform(t.coordinateToPixelTransform,e.slice()),o=this.hitRenderTarget_.readPixel(n[0]/2,n[1]/2),a=[o[0]/255,o[1]/255,o[2]/255,o[3]/255],h=colorDecodeId(a),u=this.hitRenderInstructions_[h],f=Math.floor(u).toString(),c=this.getLayer().getSource().getFeatureByUid(f);return c?i(c,this.getLayer(),null):void 0}},t.prototype.renderHitDetection=function(e){if(this.hitVerticesBuffer_.getSize()){this.hitRenderTarget_.setSize([Math.floor(e.size[0]/2),Math.floor(e.size[1]/2)]),this.helper.useProgram(this.hitProgram_),this.helper.prepareDrawToRenderTarget(e,this.hitRenderTarget_,!0),this.helper.bindBuffer(this.hitVerticesBuffer_),this.helper.bindBuffer(this.indicesBuffer_),this.helper.enableAttributes(this.hitDetectionAttributes);var t=this.indicesBuffer_.getSize();this.helper.drawElements(0,t)}},t.prototype.disposeInternal=function(){this.worker_.terminate(),this.layer_=null,this.sourceListenKeys_.forEach((function(e){unlistenByKey(e)})),this.sourceListenKeys_=null,e.prototype.disposeInternal.call(this)},t}(WebGLLayerRenderer);export default WebGLPointsLayerRenderer;
//# sourceMappingURL=/sm/554be86deac887de31b3581f60fc558586ab6c7a7abd5f5c677b2d806cbf5725.map