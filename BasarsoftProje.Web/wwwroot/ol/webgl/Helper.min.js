/**
 * Minified by jsDelivr using Terser v5.10.0.
 * Original file: /npm/ol@6.12.0/webgl/Helper.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
var __extends=this&&this.__extends||function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function a(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}();import ContextEventType from"../webgl/ContextEventType.js";import Disposable from"../Disposable.js";import WebGLPostProcessingPass from"./PostProcessingPass.js";import{FLOAT,UNSIGNED_BYTE,UNSIGNED_INT,UNSIGNED_SHORT,getContext}from"../webgl.js";import{clear}from"../obj.js";import{compose as composeTransform,create as createTransform,reset as resetTransform,rotate as rotateTransform,scale as scaleTransform}from"../transform.js";import{create,fromTransform}from"../vec/mat4.js";import{getUid}from"../util.js";export var ShaderType={FRAGMENT_SHADER:35632,VERTEX_SHADER:35633};export var DefaultUniform={PROJECTION_MATRIX:"u_projectionMatrix",OFFSET_SCALE_MATRIX:"u_offsetScaleMatrix",OFFSET_ROTATION_MATRIX:"u_offsetRotateMatrix",TIME:"u_time",ZOOM:"u_zoom",RESOLUTION:"u_resolution"};export var AttributeType={UNSIGNED_BYTE:UNSIGNED_BYTE,UNSIGNED_SHORT:UNSIGNED_SHORT,UNSIGNED_INT:UNSIGNED_INT,FLOAT:FLOAT};var canvasCache={};function getSharedCanvasCacheKey(e){return"shared/"+e}var uniqueCanvasCacheKeyCount=0;function getUniqueCanvasCacheKey(){var e="unique/"+uniqueCanvasCacheKeyCount;return uniqueCanvasCacheKeyCount+=1,e}function getCanvas(e){var t=canvasCache[e];if(!t){var r=document.createElement("canvas");r.style.position="absolute",r.style.left="0",t={users:0,canvas:r},canvasCache[e]=t}return t.users+=1,t.canvas}function releaseCanvas(e){var t=canvasCache[e];if(t&&(t.users-=1,!(t.users>0))){var r=t.canvas,a=getContext(r).getExtension("WEBGL_lose_context");a&&a.loseContext(),delete canvasCache[e]}}var WebGLHelper=function(e){function t(t){var r=e.call(this)||this,a=t||{};r.boundHandleWebGLContextLost_=r.handleWebGLContextLost.bind(r),r.boundHandleWebGLContextRestored_=r.handleWebGLContextRestored.bind(r),r.canvasCacheKey_=a.canvasCacheKey?getSharedCanvasCacheKey(a.canvasCacheKey):getUniqueCanvasCacheKey(),r.canvas_=getCanvas(r.canvasCacheKey_),r.gl_=getContext(r.canvas_),r.bufferCache_={},r.extensionCache_={},r.currentProgram_=null,r.canvas_.addEventListener(ContextEventType.LOST,r.boundHandleWebGLContextLost_),r.canvas_.addEventListener(ContextEventType.RESTORED,r.boundHandleWebGLContextRestored_),r.offsetRotateMatrix_=createTransform(),r.offsetScaleMatrix_=createTransform(),r.tmpMat4_=create(),r.uniformLocations_={},r.attribLocations_={},r.uniforms_=[],a.uniforms&&r.setUniforms(a.uniforms);var o=r.getGL();return r.postProcessPasses_=a.postProcesses?a.postProcesses.map((function(e){return new WebGLPostProcessingPass({webGlContext:o,scaleRatio:e.scaleRatio,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:e.uniforms})})):[new WebGLPostProcessingPass({webGlContext:o})],r.shaderCompileErrors_=null,r.startTime_=Date.now(),r}return __extends(t,e),t.prototype.setUniforms=function(e){for(var t in this.uniforms_=[],e)this.uniforms_.push({name:t,value:e[t]});this.uniformLocations_={}},t.prototype.canvasCacheKeyMatches=function(e){return this.canvasCacheKey_===getSharedCanvasCacheKey(e)},t.prototype.getExtension=function(e){if(e in this.extensionCache_)return this.extensionCache_[e];var t=this.gl_.getExtension(e);return this.extensionCache_[e]=t,t},t.prototype.bindBuffer=function(e){var t=this.getGL(),r=getUid(e),a=this.bufferCache_[r];a||(a={buffer:e,webGlBuffer:t.createBuffer()},this.bufferCache_[r]=a);t.bindBuffer(e.getType(),a.webGlBuffer)},t.prototype.flushBufferData=function(e){var t=this.getGL();this.bindBuffer(e),t.bufferData(e.getType(),e.getArray(),e.getUsage())},t.prototype.deleteBuffer=function(e){var t=this.getGL(),r=getUid(e),a=this.bufferCache_[r];a&&!t.isContextLost()&&t.deleteBuffer(a.webGlBuffer),delete this.bufferCache_[r]},t.prototype.disposeInternal=function(){this.canvas_.removeEventListener(ContextEventType.LOST,this.boundHandleWebGLContextLost_),this.canvas_.removeEventListener(ContextEventType.RESTORED,this.boundHandleWebGLContextRestored_),releaseCanvas(this.canvasCacheKey_),delete this.gl_,delete this.canvas_},t.prototype.prepareDraw=function(e,t){var r=this.getGL(),a=this.getCanvas(),o=e.size,n=e.pixelRatio;a.width=o[0]*n,a.height=o[1]*n,a.style.width=o[0]+"px",a.style.height=o[1]+"px",r.useProgram(this.currentProgram_);for(var s=this.postProcessPasses_.length-1;s>=0;s--)this.postProcessPasses_[s].init(e);r.bindTexture(r.TEXTURE_2D,null),r.clearColor(0,0,0,0),r.clear(r.COLOR_BUFFER_BIT),r.enable(r.BLEND),r.blendFunc(r.ONE,t?r.ZERO:r.ONE_MINUS_SRC_ALPHA),r.useProgram(this.currentProgram_),this.applyFrameState(e),this.applyUniforms(e)},t.prototype.prepareDrawToRenderTarget=function(e,t,r){var a=this.getGL(),o=t.getSize();a.bindFramebuffer(a.FRAMEBUFFER,t.getFramebuffer()),a.viewport(0,0,o[0],o[1]),a.bindTexture(a.TEXTURE_2D,t.getTexture()),a.clearColor(0,0,0,0),a.clear(a.COLOR_BUFFER_BIT),a.enable(a.BLEND),a.blendFunc(a.ONE,r?a.ZERO:a.ONE_MINUS_SRC_ALPHA),a.useProgram(this.currentProgram_),this.applyFrameState(e),this.applyUniforms(e)},t.prototype.drawElements=function(e,t){var r=this.getGL();this.getExtension("OES_element_index_uint");var a=r.UNSIGNED_INT,o=t-e,n=4*e;r.drawElements(r.TRIANGLES,o,a,n)},t.prototype.finalizeDraw=function(e,t,r){for(var a=0,o=this.postProcessPasses_.length;a<o;a++)a===o-1?this.postProcessPasses_[a].apply(e,null,t,r):this.postProcessPasses_[a].apply(e,this.postProcessPasses_[a+1])},t.prototype.getCanvas=function(){return this.canvas_},t.prototype.getGL=function(){return this.gl_},t.prototype.applyFrameState=function(e){var t=e.size,r=e.viewState.rotation,a=resetTransform(this.offsetScaleMatrix_);scaleTransform(a,2/t[0],2/t[1]);var o=resetTransform(this.offsetRotateMatrix_);0!==r&&rotateTransform(o,-r),this.setUniformMatrixValue(DefaultUniform.OFFSET_SCALE_MATRIX,fromTransform(this.tmpMat4_,a)),this.setUniformMatrixValue(DefaultUniform.OFFSET_ROTATION_MATRIX,fromTransform(this.tmpMat4_,o)),this.setUniformFloatValue(DefaultUniform.TIME,.001*(Date.now()-this.startTime_)),this.setUniformFloatValue(DefaultUniform.ZOOM,e.viewState.zoom),this.setUniformFloatValue(DefaultUniform.RESOLUTION,e.viewState.resolution)},t.prototype.applyUniforms=function(e){var t,r=this.getGL(),a=0;this.uniforms_.forEach(function(o){if((t="function"==typeof o.value?o.value(e):o.value)instanceof HTMLCanvasElement||t instanceof HTMLImageElement||t instanceof ImageData)o.texture||(o.prevValue=void 0,o.texture=r.createTexture()),r.activeTexture(r["TEXTURE"+a]),r.bindTexture(r.TEXTURE_2D,o.texture),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),(!(t instanceof HTMLImageElement)||t.complete)&&o.prevValue!==t&&(o.prevValue=t,r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,t)),r.uniform1i(this.getUniformLocation(o.name),a++);else if(Array.isArray(t)&&6===t.length)this.setUniformMatrixValue(o.name,fromTransform(this.tmpMat4_,t));else if(Array.isArray(t)&&t.length<=4)switch(t.length){case 2:return void r.uniform2f(this.getUniformLocation(o.name),t[0],t[1]);case 3:return void r.uniform3f(this.getUniformLocation(o.name),t[0],t[1],t[2]);case 4:return void r.uniform4f(this.getUniformLocation(o.name),t[0],t[1],t[2],t[3]);default:return}else"number"==typeof t&&r.uniform1f(this.getUniformLocation(o.name),t)}.bind(this))},t.prototype.useProgram=function(e){return e!=this.currentProgram_&&(this.getGL().useProgram(e),this.currentProgram_=e,this.uniformLocations_={},this.attribLocations_={},!0)},t.prototype.compileShader=function(e,t){var r=this.getGL(),a=r.createShader(t);return r.shaderSource(a,e),r.compileShader(a),a},t.prototype.getProgram=function(e,t){var r=this.getGL(),a=this.compileShader(e,r.FRAGMENT_SHADER),o=this.compileShader(t,r.VERTEX_SHADER),n=r.createProgram();if(r.attachShader(n,a),r.attachShader(n,o),r.linkProgram(n),!r.getShaderParameter(a,r.COMPILE_STATUS)){var s="Fragment shader compliation failed: "+r.getShaderInfoLog(a);throw new Error(s)}if(r.deleteShader(a),!r.getShaderParameter(o,r.COMPILE_STATUS)){s="Vertex shader compilation failed: "+r.getShaderInfoLog(o);throw new Error(s)}if(r.deleteShader(o),!r.getProgramParameter(n,r.LINK_STATUS)){s="GL program linking failed: "+r.getShaderInfoLog(o);throw new Error(s)}return n},t.prototype.getUniformLocation=function(e){return void 0===this.uniformLocations_[e]&&(this.uniformLocations_[e]=this.getGL().getUniformLocation(this.currentProgram_,e)),this.uniformLocations_[e]},t.prototype.getAttributeLocation=function(e){return void 0===this.attribLocations_[e]&&(this.attribLocations_[e]=this.getGL().getAttribLocation(this.currentProgram_,e)),this.attribLocations_[e]},t.prototype.makeProjectionTransform=function(e,t){var r=e.size,a=e.viewState.rotation,o=e.viewState.resolution,n=e.viewState.center;return resetTransform(t),composeTransform(t,0,0,2/(o*r[0]),2/(o*r[1]),-a,-n[0],-n[1]),t},t.prototype.setUniformFloatValue=function(e,t){this.getGL().uniform1f(this.getUniformLocation(e),t)},t.prototype.setUniformMatrixValue=function(e,t){this.getGL().uniformMatrix4fv(this.getUniformLocation(e),!1,t)},t.prototype.enableAttributeArray_=function(e,t,r,a,o){var n=this.getAttributeLocation(e);n<0||(this.getGL().enableVertexAttribArray(n),this.getGL().vertexAttribPointer(n,t,r,!1,a,o))},t.prototype.enableAttributes=function(e){for(var t=computeAttributesStride(e),r=0,a=0;a<e.length;a++){var o=e[a];this.enableAttributeArray_(o.name,o.size,o.type||FLOAT,t,r),r+=o.size*getByteSizeFromType(o.type)}},t.prototype.handleWebGLContextLost=function(){clear(this.bufferCache_),this.currentProgram_=null},t.prototype.handleWebGLContextRestored=function(){},t.prototype.createTexture=function(e,t,r){var a=this.getGL(),o=r||a.createTexture(),n=a.RGBA,s=a.RGBA,i=a.UNSIGNED_BYTE;return a.bindTexture(a.TEXTURE_2D,o),t?a.texImage2D(a.TEXTURE_2D,0,n,s,i,t):a.texImage2D(a.TEXTURE_2D,0,n,e[0],e[1],0,s,i,null),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),o},t}(Disposable);export function computeAttributesStride(e){for(var t=0,r=0;r<e.length;r++){var a=e[r];t+=a.size*getByteSizeFromType(a.type)}return t}function getByteSizeFromType(e){switch(e){case AttributeType.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT;case AttributeType.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT;case AttributeType.UNSIGNED_INT:return Uint32Array.BYTES_PER_ELEMENT;case AttributeType.FLOAT:default:return Float32Array.BYTES_PER_ELEMENT}}export default WebGLHelper;
//# sourceMappingURL=/sm/1d6271b084bcf9710d38372ef408bf45eba2a176af8aaa20cda4396cdecf327d.map