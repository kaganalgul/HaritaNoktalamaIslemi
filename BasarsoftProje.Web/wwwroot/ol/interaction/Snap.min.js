/**
 * Minified by jsDelivr using Terser v5.10.0.
 * Original file: /npm/ol@6.12.0/interaction/Snap.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
var __extends=this&&this.__extends||function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function o(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(o.prototype=r.prototype,new o)}}();import CollectionEventType from"../CollectionEventType.js";import EventType from"../events/EventType.js";import GeometryType from"../geom/GeometryType.js";import PointerInteraction from"./Pointer.js";import RBush from"../structs/RBush.js";import VectorEventType from"../source/VectorEventType.js";import{FALSE,TRUE}from"../functions.js";import{boundingExtent,createEmpty}from"../extent.js";import{closestOnCircle,closestOnSegment,distance as coordinateDistance,squaredDistance as squaredCoordinateDistance,squaredDistanceToSegment}from"../coordinate.js";import{fromCircle}from"../geom/Polygon.js";import{fromUserCoordinate,getUserProjection,toUserCoordinate}from"../proj.js";import{getUid}from"../util.js";import{getValues}from"../obj.js";import{listen,unlistenByKey}from"../events.js";function getFeatureFromEvent(e){return e.feature?e.feature:e.element?e.element:void 0}var tempSegment=[],Snap=function(e){function t(t){var r=this,o=t||{},n=o;return n.handleDownEvent||(n.handleDownEvent=TRUE),n.stopDown||(n.stopDown=FALSE),(r=e.call(this,n)||this).source_=o.source?o.source:null,r.vertex_=void 0===o.vertex||o.vertex,r.edge_=void 0===o.edge||o.edge,r.features_=o.features?o.features:null,r.featuresListenerKeys_=[],r.featureChangeListenerKeys_={},r.indexedFeaturesExtents_={},r.pendingFeatures_={},r.pixelTolerance_=void 0!==o.pixelTolerance?o.pixelTolerance:10,r.rBush_=new RBush,r.SEGMENT_WRITERS_={Point:r.writePointGeometry_.bind(r),LineString:r.writeLineStringGeometry_.bind(r),LinearRing:r.writeLineStringGeometry_.bind(r),Polygon:r.writePolygonGeometry_.bind(r),MultiPoint:r.writeMultiPointGeometry_.bind(r),MultiLineString:r.writeMultiLineStringGeometry_.bind(r),MultiPolygon:r.writeMultiPolygonGeometry_.bind(r),GeometryCollection:r.writeGeometryCollectionGeometry_.bind(r),Circle:r.writeCircleGeometry_.bind(r)},r}return __extends(t,e),t.prototype.addFeature=function(e,t){var r=void 0===t||t,o=getUid(e),n=e.getGeometry();if(n){var i=this.SEGMENT_WRITERS_[n.getType()];i&&(this.indexedFeaturesExtents_[o]=n.getExtent(createEmpty()),i(e,n))}r&&(this.featureChangeListenerKeys_[o]=listen(e,EventType.CHANGE,this.handleFeatureChange_,this))},t.prototype.forEachFeatureAdd_=function(e){this.addFeature(e)},t.prototype.forEachFeatureRemove_=function(e){this.removeFeature(e)},t.prototype.getFeatures_=function(){var e;return this.features_?e=this.features_:this.source_&&(e=this.source_.getFeatures()),e},t.prototype.handleEvent=function(t){var r=this.snapTo(t.pixel,t.coordinate,t.map);return r.snapped&&(t.coordinate=r.vertex.slice(0,2),t.pixel=r.vertexPixel),e.prototype.handleEvent.call(this,t)},t.prototype.handleFeatureAdd_=function(e){var t=getFeatureFromEvent(e);this.addFeature(t)},t.prototype.handleFeatureRemove_=function(e){var t=getFeatureFromEvent(e);this.removeFeature(t)},t.prototype.handleFeatureChange_=function(e){var t=e.target;if(this.handlingDownUpSequence){var r=getUid(t);r in this.pendingFeatures_||(this.pendingFeatures_[r]=t)}else this.updateFeature_(t)},t.prototype.handleUpEvent=function(e){var t=getValues(this.pendingFeatures_);return t.length&&(t.forEach(this.updateFeature_.bind(this)),this.pendingFeatures_={}),!1},t.prototype.removeFeature=function(e,t){var r=void 0===t||t,o=getUid(e),n=this.indexedFeaturesExtents_[o];if(n){var i=this.rBush_,s=[];i.forEachInExtent(n,(function(t){e===t.feature&&s.push(t)}));for(var a=s.length-1;a>=0;--a)i.remove(s[a])}r&&(unlistenByKey(this.featureChangeListenerKeys_[o]),delete this.featureChangeListenerKeys_[o])},t.prototype.setMap=function(t){var r=this.getMap(),o=this.featuresListenerKeys_,n=this.getFeatures_();r&&(o.forEach(unlistenByKey),o.length=0,n.forEach(this.forEachFeatureRemove_.bind(this))),e.prototype.setMap.call(this,t),t&&(this.features_?o.push(listen(this.features_,CollectionEventType.ADD,this.handleFeatureAdd_,this),listen(this.features_,CollectionEventType.REMOVE,this.handleFeatureRemove_,this)):this.source_&&o.push(listen(this.source_,VectorEventType.ADDFEATURE,this.handleFeatureAdd_,this),listen(this.source_,VectorEventType.REMOVEFEATURE,this.handleFeatureRemove_,this)),n.forEach(this.forEachFeatureAdd_.bind(this)))},t.prototype.snapTo=function(e,t,r){var o=r.getCoordinateFromPixel([e[0]-this.pixelTolerance_,e[1]+this.pixelTolerance_]),n=r.getCoordinateFromPixel([e[0]+this.pixelTolerance_,e[1]-this.pixelTolerance_]),i=boundingExtent([o,n]),s=this.rBush_.getInExtent(i);this.vertex_&&!this.edge_&&(s=s.filter((function(e){return e.feature.getGeometry().getType()!==GeometryType.CIRCLE})));var a=!1,u=null,l=null;if(0===s.length)return{snapped:a,vertex:u,vertexPixel:l};for(var h,p=r.getView().getProjection(),d=fromUserCoordinate(t,p),c=1/0,g=0;g<s.length;++g){var m=s[g];tempSegment[0]=fromUserCoordinate(m.segment[0],p),tempSegment[1]=fromUserCoordinate(m.segment[1],p);var f=squaredDistanceToSegment(d,tempSegment);f<c&&(h=m,c=f)}var _=h.segment;if(this.vertex_&&!this.edge_){var y=r.getPixelFromCoordinate(_[0]),v=r.getPixelFromCoordinate(_[1]),E=squaredCoordinateDistance(e,y),x=squaredCoordinateDistance(e,v);Math.sqrt(Math.min(E,x))<=this.pixelTolerance_&&(a=!0,u=E>x?_[1]:_[0],l=r.getPixelFromCoordinate(u))}else if(this.edge_){var C=h.feature.getGeometry().getType()===GeometryType.CIRCLE;if(C){var F=h.feature.getGeometry(),T=getUserProjection();T&&(F=F.clone().transform(T,p)),u=toUserCoordinate(closestOnCircle(d,F),p)}else tempSegment[0]=fromUserCoordinate(_[0],p),tempSegment[1]=fromUserCoordinate(_[1],p),u=toUserCoordinate(closestOnSegment(d,tempSegment),p);if(l=r.getPixelFromCoordinate(u),coordinateDistance(e,l)<=this.pixelTolerance_&&(a=!0,this.vertex_&&!C)){y=r.getPixelFromCoordinate(_[0]),v=r.getPixelFromCoordinate(_[1]),E=squaredCoordinateDistance(l,y),x=squaredCoordinateDistance(l,v);Math.sqrt(Math.min(E,x))<=this.pixelTolerance_&&(u=E>x?_[1]:_[0],l=r.getPixelFromCoordinate(u))}}return a&&(l=[Math.round(l[0]),Math.round(l[1])]),{snapped:a,vertex:u,vertexPixel:l}},t.prototype.updateFeature_=function(e){this.removeFeature(e,!1),this.addFeature(e,!1)},t.prototype.writeCircleGeometry_=function(e,t){var r=this.getMap().getView().getProjection(),o=t,n=getUserProjection();n&&(o=o.clone().transform(n,r));var i=fromCircle(o);n&&i.transform(r,n);for(var s=i.getCoordinates()[0],a=0,u=s.length-1;a<u;++a){var l=s.slice(a,a+2),h={feature:e,segment:l};this.rBush_.insert(boundingExtent(l),h)}},t.prototype.writeGeometryCollectionGeometry_=function(e,t){for(var r=t.getGeometriesArray(),o=0;o<r.length;++o){var n=this.SEGMENT_WRITERS_[r[o].getType()];n&&n(e,r[o])}},t.prototype.writeLineStringGeometry_=function(e,t){for(var r=t.getCoordinates(),o=0,n=r.length-1;o<n;++o){var i=r.slice(o,o+2),s={feature:e,segment:i};this.rBush_.insert(boundingExtent(i),s)}},t.prototype.writeMultiLineStringGeometry_=function(e,t){for(var r=t.getCoordinates(),o=0,n=r.length;o<n;++o)for(var i=r[o],s=0,a=i.length-1;s<a;++s){var u=i.slice(s,s+2),l={feature:e,segment:u};this.rBush_.insert(boundingExtent(u),l)}},t.prototype.writeMultiPointGeometry_=function(e,t){for(var r=t.getCoordinates(),o=0,n=r.length;o<n;++o){var i=r[o],s={feature:e,segment:[i,i]};this.rBush_.insert(t.getExtent(),s)}},t.prototype.writeMultiPolygonGeometry_=function(e,t){for(var r=t.getCoordinates(),o=0,n=r.length;o<n;++o)for(var i=r[o],s=0,a=i.length;s<a;++s)for(var u=i[s],l=0,h=u.length-1;l<h;++l){var p=u.slice(l,l+2),d={feature:e,segment:p};this.rBush_.insert(boundingExtent(p),d)}},t.prototype.writePointGeometry_=function(e,t){var r=t.getCoordinates(),o={feature:e,segment:[r,r]};this.rBush_.insert(t.getExtent(),o)},t.prototype.writePolygonGeometry_=function(e,t){for(var r=t.getCoordinates(),o=0,n=r.length;o<n;++o)for(var i=r[o],s=0,a=i.length-1;s<a;++s){var u=i.slice(s,s+2),l={feature:e,segment:u};this.rBush_.insert(boundingExtent(u),l)}},t}(PointerInteraction);export default Snap;
//# sourceMappingURL=/sm/506e4622c1798ac87a6021c7bb8c71d23829d6b74fd1ef719ae93a43ef4bd42f.map