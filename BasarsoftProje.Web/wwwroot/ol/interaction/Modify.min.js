/**
 * Minified by jsDelivr using Terser v5.10.0.
 * Original file: /npm/ol@6.12.0/interaction/Modify.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
var __extends=this&&this.__extends||function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();import Collection from"../Collection.js";import CollectionEventType from"../CollectionEventType.js";import Event from"../events/Event.js";import EventType from"../events/EventType.js";import Feature from"../Feature.js";import GeometryType from"../geom/GeometryType.js";import MapBrowserEventType from"../MapBrowserEventType.js";import Point from"../geom/Point.js";import PointerInteraction from"./Pointer.js";import RBush from"../structs/RBush.js";import VectorEventType from"../source/VectorEventType.js";import VectorLayer from"../layer/Vector.js";import VectorSource from"../source/Vector.js";import{altKeyOnly,always,primaryAction,singleClick}from"../events/condition.js";import{boundingExtent,buffer as bufferExtent,createOrUpdateFromCoordinate as createExtent}from"../extent.js";import{closestOnSegment,distance as coordinateDistance,equals as coordinatesEqual,squaredDistance as squaredCoordinateDistance,squaredDistanceToSegment}from"../coordinate.js";import{createEditingStyle}from"../style/Style.js";import{equals,includes}from"../array.js";import{fromCircle}from"../geom/Polygon.js";import{fromUserCoordinate,fromUserExtent,getUserProjection,toUserCoordinate,toUserExtent}from"../proj.js";import{getUid}from"../util.js";var CIRCLE_CENTER_INDEX=0,CIRCLE_CIRCUMFERENCE_INDEX=1,tempExtent=[0,0,0,0],tempSegment=[],ModifyEventType={MODIFYSTART:"modifystart",MODIFYEND:"modifyend"},ModifyEvent=function(e){function t(t,r,n){var o=e.call(this,t)||this;return o.features=r,o.mapBrowserEvent=n,o}return __extends(t,e),t}(Event);export{ModifyEvent};var Modify=function(e){function t(t){var r,n=e.call(this,t)||this;if(n.on,n.once,n.un,n.boundHandleFeatureChange_=n.handleFeatureChange_.bind(n),n.condition_=t.condition?t.condition:primaryAction,n.defaultDeleteCondition_=function(e){return altKeyOnly(e)&&singleClick(e)},n.deleteCondition_=t.deleteCondition?t.deleteCondition:n.defaultDeleteCondition_,n.insertVertexCondition_=t.insertVertexCondition?t.insertVertexCondition:always,n.vertexFeature_=null,n.vertexSegments_=null,n.lastPixel_=[0,0],n.ignoreNextSingleClick_=!1,n.featuresBeingModified_=null,n.rBush_=new RBush,n.pixelTolerance_=void 0!==t.pixelTolerance?t.pixelTolerance:10,n.snappedToVertex_=!1,n.changingFeature_=!1,n.dragSegments_=[],n.overlay_=new VectorLayer({source:new VectorSource({useSpatialIndex:!1,wrapX:!!t.wrapX}),style:t.style?t.style:getDefaultStyleFunction(),updateWhileAnimating:!0,updateWhileInteracting:!0}),n.SEGMENT_WRITERS_={Point:n.writePointGeometry_.bind(n),LineString:n.writeLineStringGeometry_.bind(n),LinearRing:n.writeLineStringGeometry_.bind(n),Polygon:n.writePolygonGeometry_.bind(n),MultiPoint:n.writeMultiPointGeometry_.bind(n),MultiLineString:n.writeMultiLineStringGeometry_.bind(n),MultiPolygon:n.writeMultiPolygonGeometry_.bind(n),Circle:n.writeCircleGeometry_.bind(n),GeometryCollection:n.writeGeometryCollectionGeometry_.bind(n)},n.source_=null,n.hitDetection_=null,t.features?r=t.features:t.source&&(n.source_=t.source,r=new Collection(n.source_.getFeatures()),n.source_.addEventListener(VectorEventType.ADDFEATURE,n.handleSourceAdd_.bind(n)),n.source_.addEventListener(VectorEventType.REMOVEFEATURE,n.handleSourceRemove_.bind(n))),!r)throw new Error("The modify interaction requires features, a source or a layer");return t.hitDetection&&(n.hitDetection_=t.hitDetection),n.features_=r,n.features_.forEach(n.addFeature_.bind(n)),n.features_.addEventListener(CollectionEventType.ADD,n.handleFeatureAdd_.bind(n)),n.features_.addEventListener(CollectionEventType.REMOVE,n.handleFeatureRemove_.bind(n)),n.lastPointerEvent_=null,n.delta_=[0,0],n.snapToPointer_=void 0===t.snapToPointer?!n.hitDetection_:t.snapToPointer,n}return __extends(t,e),t.prototype.addFeature_=function(e){var t=e.getGeometry();if(t){var r=this.SEGMENT_WRITERS_[t.getType()];r&&r(e,t)}var n=this.getMap();n&&n.isRendered()&&this.getActive()&&this.handlePointerAtPixel_(this.lastPixel_,n),e.addEventListener(EventType.CHANGE,this.boundHandleFeatureChange_)},t.prototype.willModifyFeatures_=function(e,t){if(!this.featuresBeingModified_){this.featuresBeingModified_=new Collection;for(var r=this.featuresBeingModified_.getArray(),n=0,o=t.length;n<o;++n)for(var i=t[n],a=0,s=i.length;a<s;++a){var d=i[a].feature;d&&-1===r.indexOf(d)&&this.featuresBeingModified_.push(d)}0===this.featuresBeingModified_.getLength()?this.featuresBeingModified_=null:this.dispatchEvent(new ModifyEvent(ModifyEventType.MODIFYSTART,this.featuresBeingModified_,e))}},t.prototype.removeFeature_=function(e){this.removeFeatureSegmentData_(e),this.vertexFeature_&&0===this.features_.getLength()&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null),e.removeEventListener(EventType.CHANGE,this.boundHandleFeatureChange_)},t.prototype.removeFeatureSegmentData_=function(e){var t=this.rBush_,r=[];t.forEach((function(t){e===t.feature&&r.push(t)}));for(var n=r.length-1;n>=0;--n){for(var o=r[n],i=this.dragSegments_.length-1;i>=0;--i)this.dragSegments_[i][0]===o&&this.dragSegments_.splice(i,1);t.remove(o)}},t.prototype.setActive=function(t){this.vertexFeature_&&!t&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null),e.prototype.setActive.call(this,t)},t.prototype.setMap=function(t){this.overlay_.setMap(t),e.prototype.setMap.call(this,t)},t.prototype.getOverlay=function(){return this.overlay_},t.prototype.handleSourceAdd_=function(e){e.feature&&this.features_.push(e.feature)},t.prototype.handleSourceRemove_=function(e){e.feature&&this.features_.remove(e.feature)},t.prototype.handleFeatureAdd_=function(e){this.addFeature_(e.element)},t.prototype.handleFeatureChange_=function(e){if(!this.changingFeature_){var t=e.target;this.removeFeature_(t),this.addFeature_(t)}},t.prototype.handleFeatureRemove_=function(e){var t=e.element;this.removeFeature_(t)},t.prototype.writePointGeometry_=function(e,t){var r=t.getCoordinates(),n={feature:e,geometry:t,segment:[r,r]};this.rBush_.insert(t.getExtent(),n)},t.prototype.writeMultiPointGeometry_=function(e,t){for(var r=t.getCoordinates(),n=0,o=r.length;n<o;++n){var i=r[n],a={feature:e,geometry:t,depth:[n],index:n,segment:[i,i]};this.rBush_.insert(t.getExtent(),a)}},t.prototype.writeLineStringGeometry_=function(e,t){for(var r=t.getCoordinates(),n=0,o=r.length-1;n<o;++n){var i=r.slice(n,n+2),a={feature:e,geometry:t,index:n,segment:i};this.rBush_.insert(boundingExtent(i),a)}},t.prototype.writeMultiLineStringGeometry_=function(e,t){for(var r=t.getCoordinates(),n=0,o=r.length;n<o;++n)for(var i=r[n],a=0,s=i.length-1;a<s;++a){var d=i.slice(a,a+2),u={feature:e,geometry:t,depth:[n],index:a,segment:d};this.rBush_.insert(boundingExtent(d),u)}},t.prototype.writePolygonGeometry_=function(e,t){for(var r=t.getCoordinates(),n=0,o=r.length;n<o;++n)for(var i=r[n],a=0,s=i.length-1;a<s;++a){var d=i.slice(a,a+2),u={feature:e,geometry:t,depth:[n],index:a,segment:d};this.rBush_.insert(boundingExtent(d),u)}},t.prototype.writeMultiPolygonGeometry_=function(e,t){for(var r=t.getCoordinates(),n=0,o=r.length;n<o;++n)for(var i=r[n],a=0,s=i.length;a<s;++a)for(var d=i[a],u=0,g=d.length-1;u<g;++u){var h=d.slice(u,u+2),l={feature:e,geometry:t,depth:[a,n],index:u,segment:h};this.rBush_.insert(boundingExtent(h),l)}},t.prototype.writeCircleGeometry_=function(e,t){var r=t.getCenter(),n={feature:e,geometry:t,index:CIRCLE_CENTER_INDEX,segment:[r,r]},o={feature:e,geometry:t,index:CIRCLE_CIRCUMFERENCE_INDEX,segment:[r,r]},i=[n,o];n.featureSegments=i,o.featureSegments=i,this.rBush_.insert(createExtent(r),n);var a=t,s=getUserProjection();if(s&&this.getMap()){var d=this.getMap().getView().getProjection();a=a.clone().transform(s,d),a=fromCircle(a).transform(d,s)}this.rBush_.insert(a.getExtent(),o)},t.prototype.writeGeometryCollectionGeometry_=function(e,t){for(var r=t.getGeometriesArray(),n=0;n<r.length;++n){var o=r[n];(0,this.SEGMENT_WRITERS_[o.getType()])(e,o)}},t.prototype.createOrUpdateVertexFeature_=function(e,t,r){var n=this.vertexFeature_;n?n.getGeometry().setCoordinates(e):(n=new Feature(new Point(e)),this.vertexFeature_=n,this.overlay_.getSource().addFeature(n));return n.set("features",t),n.set("geometries",r),n},t.prototype.handleEvent=function(t){return!t.originalEvent||(this.lastPointerEvent_=t,t.map.getView().getInteracting()||t.type!=MapBrowserEventType.POINTERMOVE||this.handlingDownUpSequence||this.handlePointerMove_(t),this.vertexFeature_&&this.deleteCondition_(t)&&(r=!(t.type!=MapBrowserEventType.SINGLECLICK||!this.ignoreNextSingleClick_)||this.removePoint()),t.type==MapBrowserEventType.SINGLECLICK&&(this.ignoreNextSingleClick_=!1),e.prototype.handleEvent.call(this,t)&&!r);var r},t.prototype.handleDragEvent=function(e){this.ignoreNextSingleClick_=!1,this.willModifyFeatures_(e,this.dragSegments_);for(var t=[e.coordinate[0]+this.delta_[0],e.coordinate[1]+this.delta_[1]],r=[],n=[],o=0,i=this.dragSegments_.length;o<i;++o){var a=this.dragSegments_[o],s=a[0],d=s.feature;-1===r.indexOf(d)&&r.push(d);var u=s.geometry;-1===n.indexOf(u)&&n.push(u);for(var g=s.depth,h=void 0,l=s.segment,p=a[1];t.length<u.getStride();)t.push(l[p][t.length]);switch(u.getType()){case GeometryType.POINT:h=t,l[0]=t,l[1]=t;break;case GeometryType.MULTI_POINT:(h=u.getCoordinates())[s.index]=t,l[0]=t,l[1]=t;break;case GeometryType.LINE_STRING:(h=u.getCoordinates())[s.index+p]=t,l[p]=t;break;case GeometryType.MULTI_LINE_STRING:case GeometryType.POLYGON:(h=u.getCoordinates())[g[0]][s.index+p]=t,l[p]=t;break;case GeometryType.MULTI_POLYGON:(h=u.getCoordinates())[g[1]][g[0]][s.index+p]=t,l[p]=t;break;case GeometryType.CIRCLE:if(l[0]=t,l[1]=t,s.index===CIRCLE_CENTER_INDEX)this.changingFeature_=!0,u.setCenter(t),this.changingFeature_=!1;else{this.changingFeature_=!0;var m=e.map.getView().getProjection(),c=coordinateDistance(fromUserCoordinate(u.getCenter(),m),fromUserCoordinate(t,m)),f=getUserProjection();if(f){var _=u.clone().transform(f,m);_.setRadius(c),c=_.transform(m,f).getRadius()}u.setRadius(c),this.changingFeature_=!1}}h&&this.setGeometryCoordinates_(u,h)}this.createOrUpdateVertexFeature_(t,r,n)},t.prototype.handleDownEvent=function(e){if(!this.condition_(e))return!1;var t=e.coordinate;this.handlePointerAtPixel_(e.pixel,e.map,t),this.dragSegments_.length=0,this.featuresBeingModified_=null;var r=this.vertexFeature_;if(r){var n=e.map.getView().getProjection(),o=[],i=r.getGeometry().getCoordinates(),a=boundingExtent([i]),s=this.rBush_.getInExtent(a),d={};s.sort(compareIndexes);for(var u=0,g=s.length;u<g;++u){var h=s[u],l=h.segment,p=getUid(h.geometry),m=h.depth;if(m&&(p+="-"+m.join("-")),d[p]||(d[p]=new Array(2)),h.geometry.getType()!==GeometryType.CIRCLE||h.index!==CIRCLE_CIRCUMFERENCE_INDEX)if(!coordinatesEqual(l[0],i)||d[p][0])if(!coordinatesEqual(l[1],i)||d[p][1])getUid(l)in this.vertexSegments_&&!d[p][0]&&!d[p][1]&&this.insertVertexCondition_(e)&&o.push(h);else{if((h.geometry.getType()===GeometryType.LINE_STRING||h.geometry.getType()===GeometryType.MULTI_LINE_STRING)&&d[p][0]&&0===d[p][0].index)continue;this.dragSegments_.push([h,1]),d[p][1]=h}else this.dragSegments_.push([h,0]),d[p][0]=h;else{var c=closestOnSegmentData(t,h,n);coordinatesEqual(c,i)&&!d[p][0]&&(this.dragSegments_.push([h,0]),d[p][0]=h)}}o.length&&this.willModifyFeatures_(e,[o]);for(var f=o.length-1;f>=0;--f)this.insertVertex_(o[f],i)}return!!this.vertexFeature_},t.prototype.handleUpEvent=function(e){for(var t=this.dragSegments_.length-1;t>=0;--t){var r=this.dragSegments_[t][0],n=r.geometry;if(n.getType()===GeometryType.CIRCLE){var o=n.getCenter(),i=r.featureSegments[0],a=r.featureSegments[1];i.segment[0]=o,i.segment[1]=o,a.segment[0]=o,a.segment[1]=o,this.rBush_.update(createExtent(o),i);var s=n,d=getUserProjection();if(d){var u=e.map.getView().getProjection();s=s.clone().transform(d,u),s=fromCircle(s).transform(u,d)}this.rBush_.update(s.getExtent(),a)}else this.rBush_.update(boundingExtent(r.segment),r)}return this.featuresBeingModified_&&(this.dispatchEvent(new ModifyEvent(ModifyEventType.MODIFYEND,this.featuresBeingModified_,e)),this.featuresBeingModified_=null),!1},t.prototype.handlePointerMove_=function(e){this.lastPixel_=e.pixel,this.handlePointerAtPixel_(e.pixel,e.map,e.coordinate)},t.prototype.handlePointerAtPixel_=function(e,t,r){var n,o,i=this,a=r||t.getCoordinateFromPixel(e),s=t.getView().getProjection();if(this.hitDetection_){var d="object"==typeof this.hitDetection_?function(e){return e===i.hitDetection_}:void 0;t.forEachFeatureAtPixel(e,(function(e,t,r){if((r=r||e.getGeometry()).getType()===GeometryType.POINT&&includes(i.features_.getArray(),e)){o=r;var a=r.getFlatCoordinates().slice(0,2);n=[{feature:e,geometry:r,segment:[a,a]}]}return!0}),{layerFilter:d})}if(!n){var u=fromUserExtent(createExtent(a,tempExtent),s),g=t.getView().getResolution()*this.pixelTolerance_,h=toUserExtent(bufferExtent(u,g,tempExtent),s);n=this.rBush_.getInExtent(h)}if(n&&n.length>0){var l=n.sort((function(e,t){return projectedDistanceToSegmentDataSquared(a,e,s)-projectedDistanceToSegmentDataSquared(a,t,s)}))[0],p=l.segment,m=closestOnSegmentData(a,l,s),c=t.getPixelFromCoordinate(m),f=coordinateDistance(e,c);if(o||f<=this.pixelTolerance_){var _={};if(_[getUid(p)]=!0,this.snapToPointer_||(this.delta_[0]=m[0]-a[0],this.delta_[1]=m[1]-a[1]),l.geometry.getType()===GeometryType.CIRCLE&&l.index===CIRCLE_CIRCUMFERENCE_INDEX)this.snappedToVertex_=!0,this.createOrUpdateVertexFeature_(m,[l.feature],[l.geometry]);else{var y=t.getPixelFromCoordinate(p[0]),v=t.getPixelFromCoordinate(p[1]),E=squaredCoordinateDistance(c,y),C=squaredCoordinateDistance(c,v);f=Math.sqrt(Math.min(E,C)),this.snappedToVertex_=f<=this.pixelTolerance_,this.snappedToVertex_&&(m=E>C?p[1]:p[0]),this.createOrUpdateVertexFeature_(m,[l.feature],[l.geometry]);var x={};x[getUid(l.geometry)]=!0;for(var T=1,S=n.length;T<S;++T){var I=n[T].segment;if(!(coordinatesEqual(p[0],I[0])&&coordinatesEqual(p[1],I[1])||coordinatesEqual(p[0],I[1])&&coordinatesEqual(p[1],I[0])))break;var F=getUid(n[T].geometry);F in x||(x[F]=!0,_[getUid(I)]=!0)}}return void(this.vertexSegments_=_)}}this.vertexFeature_&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null)},t.prototype.insertVertex_=function(e,t){for(var r,n=e.segment,o=e.feature,i=e.geometry,a=e.depth,s=e.index;t.length<i.getStride();)t.push(0);switch(i.getType()){case GeometryType.MULTI_LINE_STRING:case GeometryType.POLYGON:(r=i.getCoordinates())[a[0]].splice(s+1,0,t);break;case GeometryType.MULTI_POLYGON:(r=i.getCoordinates())[a[1]][a[0]].splice(s+1,0,t);break;case GeometryType.LINE_STRING:(r=i.getCoordinates()).splice(s+1,0,t);break;default:return}this.setGeometryCoordinates_(i,r);var d=this.rBush_;d.remove(e),this.updateSegmentIndices_(i,s,a,1);var u={segment:[n[0],t],feature:o,geometry:i,depth:a,index:s};d.insert(boundingExtent(u.segment),u),this.dragSegments_.push([u,1]);var g={segment:[t,n[1]],feature:o,geometry:i,depth:a,index:s+1};d.insert(boundingExtent(g.segment),g),this.dragSegments_.push([g,0]),this.ignoreNextSingleClick_=!0},t.prototype.removePoint=function(){if(this.lastPointerEvent_&&this.lastPointerEvent_.type!=MapBrowserEventType.POINTERDRAG){var e=this.lastPointerEvent_;this.willModifyFeatures_(e,this.dragSegments_);var t=this.removeVertex_();return this.featuresBeingModified_&&this.dispatchEvent(new ModifyEvent(ModifyEventType.MODIFYEND,this.featuresBeingModified_,e)),this.featuresBeingModified_=null,t}return!1},t.prototype.removeVertex_=function(){var e,t,r,n,o,i,a,s,d,u,g,h=this.dragSegments_,l={},p=!1;for(o=h.length-1;o>=0;--o)u=(r=h[o])[0],g=getUid(u.feature),u.depth&&(g+="-"+u.depth.join("-")),g in l||(l[g]={}),0===r[1]?(l[g].right=u,l[g].index=u.index):1==r[1]&&(l[g].left=u,l[g].index=u.index+1);for(g in l){switch(d=l[g].right,a=l[g].left,(s=(i=l[g].index)-1)<0&&(s=0),e=t=(n=(u=void 0!==a?a:d).geometry).getCoordinates(),p=!1,n.getType()){case GeometryType.MULTI_LINE_STRING:t[u.depth[0]].length>2&&(t[u.depth[0]].splice(i,1),p=!0);break;case GeometryType.LINE_STRING:t.length>2&&(t.splice(i,1),p=!0);break;case GeometryType.MULTI_POLYGON:e=e[u.depth[1]];case GeometryType.POLYGON:(e=e[u.depth[0]]).length>4&&(i==e.length-1&&(i=0),e.splice(i,1),p=!0,0===i&&(e.pop(),e.push(e[0]),s=e.length-1))}if(p){this.setGeometryCoordinates_(n,t);var m=[];if(void 0!==a&&(this.rBush_.remove(a),m.push(a.segment[0])),void 0!==d&&(this.rBush_.remove(d),m.push(d.segment[1])),void 0!==a&&void 0!==d){var c={depth:u.depth,feature:u.feature,geometry:u.geometry,index:s,segment:m};this.rBush_.insert(boundingExtent(c.segment),c)}this.updateSegmentIndices_(n,i,u.depth,-1),this.vertexFeature_&&(this.overlay_.getSource().removeFeature(this.vertexFeature_),this.vertexFeature_=null),h.length=0}}return p},t.prototype.setGeometryCoordinates_=function(e,t){this.changingFeature_=!0,e.setCoordinates(t),this.changingFeature_=!1},t.prototype.updateSegmentIndices_=function(e,t,r,n){this.rBush_.forEachInExtent(e.getExtent(),(function(o){o.geometry===e&&(void 0===r||void 0===o.depth||equals(o.depth,r))&&o.index>t&&(o.index+=n)}))},t}(PointerInteraction);function compareIndexes(e,t){return e.index-t.index}function projectedDistanceToSegmentDataSquared(e,t,r){var n=t.geometry;if(n.getType()===GeometryType.CIRCLE){var o=n;if(t.index===CIRCLE_CIRCUMFERENCE_INDEX){var i=getUserProjection();i&&(o=o.clone().transform(i,r));var a=squaredCoordinateDistance(o.getCenter(),fromUserCoordinate(e,r)),s=Math.sqrt(a)-o.getRadius();return s*s}}var d=fromUserCoordinate(e,r);return tempSegment[0]=fromUserCoordinate(t.segment[0],r),tempSegment[1]=fromUserCoordinate(t.segment[1],r),squaredDistanceToSegment(d,tempSegment)}function closestOnSegmentData(e,t,r){var n=t.geometry;if(n.getType()===GeometryType.CIRCLE&&t.index===CIRCLE_CIRCUMFERENCE_INDEX){var o=n,i=getUserProjection();return i&&(o=o.clone().transform(i,r)),toUserCoordinate(o.getClosestPoint(fromUserCoordinate(e,r)),r)}var a=fromUserCoordinate(e,r);return tempSegment[0]=fromUserCoordinate(t.segment[0],r),tempSegment[1]=fromUserCoordinate(t.segment[1],r),toUserCoordinate(closestOnSegment(a,tempSegment),r)}function getDefaultStyleFunction(){var e=createEditingStyle();return function(t,r){return e[GeometryType.POINT]}}export default Modify;
//# sourceMappingURL=/sm/fd01c9d58bfe80cac089af93f8e707d534a9405f0231358755cdbc3154e8b481.map