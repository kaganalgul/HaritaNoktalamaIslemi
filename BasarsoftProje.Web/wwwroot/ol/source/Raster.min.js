/**
 * Minified by jsDelivr using Terser v5.10.0.
 * Original file: /npm/ol@6.12.0/source/Raster.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
var __extends=this&&this.__extends||function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function a(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}();import Disposable from"../Disposable.js";import Event from"../events/Event.js";import EventType from"../events/EventType.js";import ImageCanvas from"../ImageCanvas.js";import ImageLayer from"../layer/Image.js";import ImageSource from"./Image.js";import Source from"./Source.js";import SourceState from"./State.js";import TileLayer from"../layer/Tile.js";import TileQueue from"../TileQueue.js";import TileSource from"./Tile.js";import{assign}from"../obj.js";import{createCanvasContext2D}from"../dom.js";import{create as createTransform}from"../transform.js";import{equals,getCenter,getHeight,getWidth}from"../extent.js";import{getUid}from"../util.js";var context,hasImageData=!0;try{new ImageData(10,10)}catch(e){hasImageData=!1}export function newImageData(e,t,r){if(hasImageData)return new ImageData(e,t,r);context||(context=document.createElement("canvas").getContext("2d"));var a=context.createImageData(t,r);return a.data.set(e),a}function createMinion(e){var t=!0;try{new ImageData(10,10)}catch(e){t=!1}function r(e,r,a){return t?new ImageData(e,r,a):{data:e,width:r,height:a}}return function(t){var a=t.buffers,n=t.meta,o=t.imageOps,s=t.width,i=t.height,u=a.length,p=a[0].byteLength;if(o){for(var h=new Array(u),c=0;c<u;++c)h[c]=r(new Uint8ClampedArray(a[c]),s,i);return e(h,n).data.buffer}var l=new Uint8ClampedArray(p),d=new Array(u),f=new Array(u);for(c=0;c<u;++c)d[c]=new Uint8ClampedArray(a[c]),f[c]=[0,0,0,0];for(var m=0;m<p;m+=4){for(var g=0;g<u;++g){var v=d[g];f[g][0]=v[m],f[g][1]=v[m+1],f[g][2]=v[m+2],f[g][3]=v[m+3]}var _=e(f,n);l[m]=_[0],l[m+1]=_[1],l[m+2]=_[2],l[m+3]=_[3]}return l.buffer}}function createWorker(e,t){var r=Object.keys(e.lib||{}).map((function(t){return"var "+t+" = "+e.lib[t].toString()+";"})).concat(["var __minion__ = ("+createMinion.toString()+")(",e.operation.toString(),");",'self.addEventListener("message", function(event) {',"  var buffer = __minion__(event.data);","  self.postMessage({buffer: buffer, meta: event.data.meta}, [buffer]);","});"]),a=new Worker("undefined"==typeof Blob?"data:text/javascript;base64,"+Buffer.from(r.join("\n"),"binary").toString("base64"):URL.createObjectURL(new Blob(r,{type:"text/javascript"})));return a.addEventListener("message",t),a}function createFauxWorker(e,t){var r=createMinion(e.operation),a=!1;return{postMessage:function(e){setTimeout((function(){a||t({data:{buffer:r(e),meta:e.meta}})}),0)},terminate:function(){a=!0}}}var Processor=function(e){function t(t){var r,a=e.call(this)||this;a._imageOps=!!t.imageOps,r=0===t.threads?0:a._imageOps?1:t.threads||1;var n=new Array(r);if(r)for(var o=0;o<r;++o)n[o]=createWorker(t,a._onWorkerMessage.bind(a,o));else n[0]=createFauxWorker(t,a._onWorkerMessage.bind(a,0));return a._workers=n,a._queue=[],a._maxQueueLength=t.queue||1/0,a._running=0,a._dataLookup={},a._job=null,a}return __extends(t,e),t.prototype.process=function(e,t,r){this._enqueue({inputs:e,meta:t,callback:r}),this._dispatch()},t.prototype._enqueue=function(e){for(this._queue.push(e);this._queue.length>this._maxQueueLength;)this._queue.shift().callback(null,null)},t.prototype._dispatch=function(){if(!this._running&&0!==this._queue.length){var e=this._queue.shift();this._job=e;var t=e.inputs[0].width,r=e.inputs[0].height,a=e.inputs.map((function(e){return e.data.buffer})),n=this._workers.length;if(this._running=n,1!==n)for(var o=e.inputs[0].data.length,s=4*Math.ceil(o/4/n),i=0;i<n;++i){for(var u=i*s,p=[],h=0,c=a.length;h<c;++h)p.push(a[h].slice(u,u+s));this._workers[i].postMessage({buffers:p,meta:e.meta,imageOps:this._imageOps,width:t,height:r},p)}else this._workers[0].postMessage({buffers:a,meta:e.meta,imageOps:this._imageOps,width:t,height:r},a)}},t.prototype._onWorkerMessage=function(e,t){this.disposed||(this._dataLookup[e]=t.data,--this._running,0===this._running&&this._resolveJob())},t.prototype._resolveJob=function(){var e,t,r=this._job,a=this._workers.length;if(1===a)e=new Uint8ClampedArray(this._dataLookup[0].buffer),t=this._dataLookup[0].meta;else{var n=r.inputs[0].data.length;e=new Uint8ClampedArray(n),t=new Array(a);for(var o=4*Math.ceil(n/4/a),s=0;s<a;++s){var i=this._dataLookup[s].buffer,u=s*o;e.set(new Uint8ClampedArray(i),u),t[s]=this._dataLookup[s].meta}}this._job=null,this._dataLookup={},r.callback(null,newImageData(e,r.inputs[0].width,r.inputs[0].height),t),this._dispatch()},t.prototype.disposeInternal=function(){for(var e=0;e<this._workers.length;++e)this._workers[e].terminate();this._workers.length=0},t}(Disposable);export{Processor};var RasterEventType={BEFOREOPERATIONS:"beforeoperations",AFTEROPERATIONS:"afteroperations"},RasterOperationType={PIXEL:"pixel",IMAGE:"image"},RasterSourceEvent=function(e){function t(t,r,a){var n=e.call(this,t)||this;return n.extent=r.extent,n.resolution=r.viewState.resolution/r.pixelRatio,n.data=a,n}return __extends(t,e),t}(Event);export{RasterSourceEvent};var RasterSource=function(e){function t(t){var r=e.call(this,{projection:null})||this;r.on,r.once,r.un,r.processor_=null,r.operationType_=void 0!==t.operationType?t.operationType:RasterOperationType.PIXEL,r.threads_=void 0!==t.threads?t.threads:1,r.layers_=createLayers(t.sources);for(var a=r.changed.bind(r),n=0,o=r.layers_.length;n<o;++n)r.layers_[n].addEventListener(EventType.CHANGE,a);return r.tileQueue_=new TileQueue((function(){return 1}),r.changed.bind(r)),r.requestedFrameState_,r.renderedImageCanvas_=null,r.renderedRevision_,r.frameState_={animate:!1,coordinateToPixelTransform:createTransform(),declutterTree:null,extent:null,index:0,layerIndex:0,layerStatesArray:getLayerStatesArray(r.layers_),pixelRatio:1,pixelToCoordinateTransform:createTransform(),postRenderFunctions:[],size:[0,0],tileQueue:r.tileQueue_,time:Date.now(),usedTiles:{},viewState:{rotation:0},viewHints:[],wantedTiles:{},mapId:getUid(r),renderTargets:{}},r.setAttributions((function(e){for(var r=[],a=0,n=t.sources.length;a<n;++a){var o=t.sources[a],s=(o instanceof Source?o:o.getSource()).getAttributions();if("function"==typeof s){var i=s(e);r.push.apply(r,i)}}return 0!==r.length?r:null})),void 0!==t.operation&&r.setOperation(t.operation,t.lib),r}return __extends(t,e),t.prototype.setOperation=function(e,t){this.processor_&&this.processor_.dispose(),this.processor_=new Processor({operation:e,imageOps:this.operationType_===RasterOperationType.IMAGE,queue:1,lib:t,threads:this.threads_}),this.changed()},t.prototype.updateFrameState_=function(e,t,r){var a=assign({},this.frameState_);a.viewState=assign({},a.viewState);var n=getCenter(e);a.extent=e.slice(),a.size[0]=Math.round(getWidth(e)/t),a.size[1]=Math.round(getHeight(e)/t),a.time=Date.now();var o=a.viewState;return o.center=n,o.projection=r,o.resolution=t,a},t.prototype.allSourcesReady_=function(){for(var e=!0,t=0,r=this.layers_.length;t<r;++t)if(this.layers_[t].getSource().getState()!==SourceState.READY){e=!1;break}return e},t.prototype.getImage=function(e,t,r,a){if(!this.allSourcesReady_())return null;var n=this.updateFrameState_(e,t,a);if(this.requestedFrameState_=n,this.renderedImageCanvas_){var o=this.renderedImageCanvas_.getResolution(),s=this.renderedImageCanvas_.getExtent();t===o&&equals(e,s)||(this.renderedImageCanvas_=null)}return this.renderedImageCanvas_&&this.getRevision()===this.renderedRevision_||this.processSources_(),n.tileQueue.loadMoreTiles(16,16),n.animate&&requestAnimationFrame(this.changed.bind(this)),this.renderedImageCanvas_},t.prototype.processSources_=function(){for(var e=this.requestedFrameState_,t=this.layers_.length,r=new Array(t),a=0;a<t;++a){e.layerIndex=a;var n=getImageData(this.layers_[a],e);if(!n)return;r[a]=n}var o={};this.dispatchEvent(new RasterSourceEvent(RasterEventType.BEFOREOPERATIONS,e,o)),this.processor_.process(r,o,this.onWorkerComplete_.bind(this,e))},t.prototype.onWorkerComplete_=function(e,t,r,a){if(!t&&r){var n=e.extent,o=e.viewState.resolution;if(o===this.requestedFrameState_.viewState.resolution&&equals(n,this.requestedFrameState_.extent)){var s;if(this.renderedImageCanvas_)s=this.renderedImageCanvas_.getImage().getContext("2d");else{var i=Math.round(getWidth(n)/o),u=Math.round(getHeight(n)/o);s=createCanvasContext2D(i,u),this.renderedImageCanvas_=new ImageCanvas(n,o,1,s.canvas)}s.putImageData(r,0,0),this.changed(),this.renderedRevision_=this.getRevision(),this.dispatchEvent(new RasterSourceEvent(RasterEventType.AFTEROPERATIONS,e,a)),e.animate&&requestAnimationFrame(this.changed.bind(this))}}},t.prototype.disposeInternal=function(){this.processor_&&this.processor_.dispose(),e.prototype.disposeInternal.call(this)},t}(ImageSource);RasterSource.prototype.dispose;var sharedContext=null;function getImageData(e,t){var r=e.getRenderer();if(!r)throw new Error("Unsupported layer type: "+e);if(!r.prepareFrame(t))return null;var a=t.size[0],n=t.size[1];if(0===a||0===n)return null;var o,s=r.renderFrame(t,null);if(s&&(o=s.firstElementChild),!(o instanceof HTMLCanvasElement))throw new Error("Unsupported rendered element: "+o);if(o.width===a&&o.height===n)return o.getContext("2d").getImageData(0,0,a,n);if(sharedContext){var i=sharedContext.canvas;i.width!==a||i.height!==n?sharedContext=createCanvasContext2D(a,n):sharedContext.clearRect(0,0,a,n)}else sharedContext=createCanvasContext2D(a,n);return sharedContext.drawImage(o,0,0,a,n),sharedContext.getImageData(0,0,a,n)}function getLayerStatesArray(e){return e.map((function(e){return e.getLayerState()}))}function createLayers(e){for(var t=e.length,r=new Array(t),a=0;a<t;++a)r[a]=createLayer(e[a]);return r}function createLayer(e){var t;return e instanceof Source?e instanceof TileSource?t=new TileLayer({source:e}):e instanceof ImageSource&&(t=new ImageLayer({source:e})):t=e,t}export default RasterSource;
//# sourceMappingURL=/sm/2d97f0f56b58c6df104be36e427a90816b98018b803a2551565091ac5efea2c5.map