/**
 * Minified by jsDelivr using Terser v5.10.0.
 * Original file: /npm/ol@6.12.0/render/canvas/Executor.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import CanvasInstruction from"./Instruction.js";import{TEXT_ALIGN}from"./TextBuilder.js";import{WORKER_OFFSCREEN_CANVAS}from"../../has.js";import{apply as applyTransform,compose as composeTransform,create as createTransform,setFromArray as transformSetFromArray}from"../../transform.js";import{createEmpty,createOrUpdate,intersects}from"../../extent.js";import{defaultPadding,defaultTextBaseline,drawImageOrLabel}from"../canvas.js";import{defaultTextAlign,measureAndCacheTextWidth,measureTextHeight,measureTextWidths}from"../canvas.js";import{drawTextOnPath}from"../../geom/flat/textpath.js";import{equals}from"../../array.js";import{lineStringLength}from"../../geom/flat/length.js";import{transform2D}from"../../geom/flat/transform.js";var tmpExtent=createEmpty(),p1=[],p2=[],p3=[],p4=[];function getDeclutterBox(t){return t[3].declutterBox}var rtlRegEx=new RegExp("["+String.fromCharCode(1425)+"-"+String.fromCharCode(2303)+String.fromCharCode(64285)+"-"+String.fromCharCode(65023)+String.fromCharCode(65136)+"-"+String.fromCharCode(65276)+String.fromCharCode(67584)+"-"+String.fromCharCode(69631)+String.fromCharCode(124928)+"-"+String.fromCharCode(126975)+"]");function horizontalTextAlign(t,e){return"start"!==e&&"end"!==e||rtlRegEx.test(t)||(e="start"===e?"left":"right"),TEXT_ALIGN[e]}var Executor=function(){function t(t,e,i,a){this.overlaps=i,this.pixelRatio=e,this.resolution=t,this.alignFill_,this.instructions=a.instructions,this.coordinates=a.coordinates,this.coordinateCache_={},this.renderedTransform_=createTransform(),this.hitDetectionInstructions=a.hitDetectionInstructions,this.pixelCoordinates_=null,this.viewRotation_=0,this.fillStates=a.fillStates||{},this.strokeStates=a.strokeStates||{},this.textStates=a.textStates||{},this.widths_={},this.labels_={}}return t.prototype.createLabel=function(t,e,i,a){var r=t+e+i+a;if(this.labels_[r])return this.labels_[r];var s=a?this.strokeStates[a]:null,n=i?this.fillStates[i]:null,o=this.textStates[e],l=this.pixelRatio,h=[o.scale[0]*l,o.scale[1]*l],p=horizontalTextAlign(t,o.textAlign||defaultTextAlign),c=a&&s.lineWidth?s.lineWidth:0,d=t.split("\n"),m=d.length,f=[],u=measureTextWidths(o.font,d,f),g=measureTextHeight(o.font),x=u+c,v=[],_=(x+2)*h[0],T=(g*m+c)*h[1],C={width:_<0?Math.floor(_):Math.ceil(_),height:T<0?Math.floor(T):Math.ceil(T),contextInstructions:v};(1==h[0]&&1==h[1]||v.push("scale",h),v.push("font",o.font),a)&&(v.push("strokeStyle",s.strokeStyle),v.push("lineWidth",c),v.push("lineCap",s.lineCap),v.push("lineJoin",s.lineJoin),v.push("miterLimit",s.miterLimit),(WORKER_OFFSCREEN_CANVAS?OffscreenCanvasRenderingContext2D:CanvasRenderingContext2D).prototype.setLineDash&&(v.push("setLineDash",[s.lineDash]),v.push("lineDashOffset",s.lineDashOffset)));i&&v.push("fillStyle",n.fillStyle),v.push("textBaseline","middle"),v.push("textAlign","center");var S,y=.5-p,I=p*x+y*c;if(a)for(S=0;S<m;++S)v.push("strokeText",[d[S],I+y*f[S],.5*(c+g)+S*g]);if(i)for(S=0;S<m;++S)v.push("fillText",[d[S],I+y*f[S],.5*(c+g)+S*g]);return this.labels_[r]=C,C},t.prototype.replayTextBackground_=function(t,e,i,a,r,s,n){t.beginPath(),t.moveTo.apply(t,e),t.lineTo.apply(t,i),t.lineTo.apply(t,a),t.lineTo.apply(t,r),t.lineTo.apply(t,e),s&&(this.alignFill_=s[2],this.fill_(t)),n&&(this.setStrokeStyle_(t,n),t.stroke())},t.prototype.calculateImageOrLabelDimensions_=function(t,e,i,a,r,s,n,o,l,h,p,c,d,m,f,u){var g,x=i-(n*=c[0]),v=a-(o*=c[1]),_=r+l>t?t-l:r,T=s+h>e?e-h:s,C=m[3]+_*c[0]+m[1],S=m[0]+T*c[1]+m[2],y=x-m[3],I=v-m[0];return(f||0!==p)&&(p1[0]=y,p4[0]=y,p1[1]=I,p2[1]=I,p2[0]=y+C,p3[0]=p2[0],p3[1]=I+S,p4[1]=p3[1]),0!==p?(g=composeTransform(createTransform(),i,a,1,1,p,-i,-a),applyTransform(g,p1),applyTransform(g,p2),applyTransform(g,p3),applyTransform(g,p4),createOrUpdate(Math.min(p1[0],p2[0],p3[0],p4[0]),Math.min(p1[1],p2[1],p3[1],p4[1]),Math.max(p1[0],p2[0],p3[0],p4[0]),Math.max(p1[1],p2[1],p3[1],p4[1]),tmpExtent)):createOrUpdate(Math.min(y,y+C),Math.min(I,I+S),Math.max(y,y+C),Math.max(I,I+S),tmpExtent),d&&(x=Math.round(x),v=Math.round(v)),{drawImageX:x,drawImageY:v,drawImageW:_,drawImageH:T,originX:l,originY:h,declutterBox:{minX:tmpExtent[0],minY:tmpExtent[1],maxX:tmpExtent[2],maxY:tmpExtent[3],value:u},canvasTransform:g,scale:c}},t.prototype.replayImageOrLabel_=function(t,e,i,a,r,s,n){var o=!(!s&&!n),l=a.declutterBox,h=t.canvas,p=n?n[2]*a.scale[0]/2:0;return l.minX-p<=h.width/e&&l.maxX+p>=0&&l.minY-p<=h.height/e&&l.maxY+p>=0&&(o&&this.replayTextBackground_(t,p1,p2,p3,p4,s,n),drawImageOrLabel(t,a.canvasTransform,r,i,a.originX,a.originY,a.drawImageW,a.drawImageH,a.drawImageX,a.drawImageY,a.scale)),!0},t.prototype.fill_=function(t){if(this.alignFill_){var e=applyTransform(this.renderedTransform_,[0,0]),i=512*this.pixelRatio;t.save(),t.translate(e[0]%i,e[1]%i),t.rotate(this.viewRotation_)}t.fill(),this.alignFill_&&t.restore()},t.prototype.setStrokeStyle_=function(t,e){t.strokeStyle=e[1],t.lineWidth=e[2],t.lineCap=e[3],t.lineJoin=e[4],t.miterLimit=e[5],t.setLineDash&&(t.lineDashOffset=e[7],t.setLineDash(e[6]))},t.prototype.drawLabelWithPointPlacement_=function(t,e,i,a){var r=this.textStates[e],s=this.createLabel(t,e,a,i),n=this.strokeStates[i],o=this.pixelRatio,l=horizontalTextAlign(t,r.textAlign||defaultTextAlign),h=TEXT_ALIGN[r.textBaseline||defaultTextBaseline],p=n&&n.lineWidth?n.lineWidth:0;return{label:s,anchorX:l*(s.width/o-2*r.scale[0])+2*(.5-l)*p,anchorY:h*s.height/o+2*(.5-h)*p}},t.prototype.execute_=function(t,e,i,a,r,s,n,o){var l;this.pixelCoordinates_&&equals(i,this.renderedTransform_)?l=this.pixelCoordinates_:(this.pixelCoordinates_||(this.pixelCoordinates_=[]),l=transform2D(this.coordinates,0,this.coordinates.length,2,i,this.pixelCoordinates_),transformSetFromArray(this.renderedTransform_,i));for(var h,p,c,d,m,f,u,g,x,v,_,T,C,S,y,I,E=0,b=a.length,L=0,w=0,k=0,R=null,O=null,A=this.coordinateCache_,D=this.viewRotation_,M=Math.round(1e12*Math.atan2(-i[1],i[0]))/1e12,B={context:t,pixelRatio:this.pixelRatio,resolution:this.resolution,rotation:D},W=this.instructions!=a||this.overlaps?0:200;E<b;){var N=a[E];switch(N[0]){case CanvasInstruction.BEGIN_GEOMETRY:C=N[1],I=N[3],C.getGeometry()?void 0===n||intersects(n,I.getExtent())?++E:E=N[2]+1:E=N[2];break;case CanvasInstruction.BEGIN_PATH:w>W&&(this.fill_(t),w=0),k>W&&(t.stroke(),k=0),w||k||(t.beginPath(),d=NaN,m=NaN),++E;break;case CanvasInstruction.CIRCLE:var P=l[L=N[1]],F=l[L+1],X=l[L+2]-P,Y=l[L+3]-F,j=Math.sqrt(X*X+Y*Y);t.moveTo(P+j,F),t.arc(P,F,j,0,2*Math.PI,!0),++E;break;case CanvasInstruction.CLOSE_PATH:t.closePath(),++E;break;case CanvasInstruction.CUSTOM:L=N[1],h=N[2];var G=N[3],H=N[4],K=6==N.length?N[5]:void 0;B.geometry=G,B.feature=C,E in A||(A[E]=[]);var U=A[E];K?K(l,L,h,2,U):(U[0]=l[L],U[1]=l[L+1],U.length=2),H(U,B),++E;break;case CanvasInstruction.DRAW_IMAGE:L=N[1],h=N[2],g=N[3],p=N[4],c=N[5];var q=N[6],z=N[7],J=N[8],V=N[9],Q=N[10],Z=N[11],$=N[12],tt=N[13],et=N[14];if(!g&&N.length>=19){x=N[18],v=N[19],_=N[20],T=N[21];var it=this.drawLabelWithPointPlacement_(x,v,_,T);g=it.label,N[3]=g;var at=N[22];p=(it.anchorX-at)*this.pixelRatio,N[4]=p;var rt=N[23];c=(it.anchorY-rt)*this.pixelRatio,N[5]=c,q=g.height,N[6]=q,tt=g.width,N[13]=tt}var st=void 0;N.length>24&&(st=N[24]);var nt=void 0,ot=void 0,lt=void 0;N.length>16?(nt=N[15],ot=N[16],lt=N[17]):(nt=defaultPadding,ot=!1,lt=!1),Q&&M?Z+=D:Q||M||(Z-=D);for(var ht=0;L<h;L+=2)if(!(st&&st[ht++]<tt/this.pixelRatio)){var pt=[t,e,g,Pt=this.calculateImageOrLabelDimensions_(g.width,g.height,l[L],l[L+1],tt,q,p,c,J,V,Z,$,r,nt,ot||lt,C),z,ot?R:null,lt?O:null],ct=void 0,dt=void 0;if(o&&et){var mt=h-L;if(!et[mt]){et[mt]=pt;continue}if(ct=et[mt],delete et[mt],dt=getDeclutterBox(ct),o.collides(dt))continue}o&&o.collides(Pt.declutterBox)||(ct&&(o&&o.insert(dt),this.replayImageOrLabel_.apply(this,ct)),o&&o.insert(Pt.declutterBox),this.replayImageOrLabel_.apply(this,pt))}++E;break;case CanvasInstruction.DRAW_CHARS:var ft=N[1],ut=N[2],gt=N[3],xt=N[4];T=N[5];var vt=N[6],_t=N[7],Tt=N[8];_=N[9];var Ct=N[10];x=N[11],v=N[12];var St=[N[13],N[13]],yt=this.textStates[v],It=yt.font,Et=[yt.scale[0]*_t,yt.scale[1]*_t],bt=void 0;It in this.widths_?bt=this.widths_[It]:(bt={},this.widths_[It]=bt);var Lt=lineStringLength(l,ft,ut,2),wt=Math.abs(Et[0])*measureAndCacheTextWidth(It,x,bt);if(xt||wt<=Lt){var kt=this.textStates[v].textAlign,Rt=(Lt-wt)*TEXT_ALIGN[kt],Ot=drawTextOnPath(l,ft,ut,2,x,Rt,vt,Math.abs(Et[0]),measureAndCacheTextWidth,It,bt,M?0:this.viewRotation_);t:if(Ot){var At=[],Dt=void 0,Mt=void 0,Bt=void 0,Wt=void 0,Nt=void 0;if(_)for(Dt=0,Mt=Ot.length;Dt<Mt;++Dt){Bt=(Nt=Ot[Dt])[4],Wt=this.createLabel(Bt,v,"",_),p=Nt[2]+(Et[0]<0?-Ct:Ct),c=gt*Wt.height+2*(.5-gt)*Ct*Et[1]/Et[0]-Tt;var Pt=this.calculateImageOrLabelDimensions_(Wt.width,Wt.height,Nt[0],Nt[1],Wt.width,Wt.height,p,c,0,0,Nt[3],St,!1,defaultPadding,!1,C);if(o&&o.collides(Pt.declutterBox))break t;At.push([t,e,Wt,Pt,1,null,null])}if(T)for(Dt=0,Mt=Ot.length;Dt<Mt;++Dt){Bt=(Nt=Ot[Dt])[4],Wt=this.createLabel(Bt,v,T,""),p=Nt[2],c=gt*Wt.height-Tt;Pt=this.calculateImageOrLabelDimensions_(Wt.width,Wt.height,Nt[0],Nt[1],Wt.width,Wt.height,p,c,0,0,Nt[3],St,!1,defaultPadding,!1,C);if(o&&o.collides(Pt.declutterBox))break t;At.push([t,e,Wt,Pt,1,null,null])}o&&o.load(At.map(getDeclutterBox));for(var Ft=0,Xt=At.length;Ft<Xt;++Ft)this.replayImageOrLabel_.apply(this,At[Ft])}}++E;break;case CanvasInstruction.END_GEOMETRY:if(void 0!==s){var Yt=s(C=N[1],I);if(Yt)return Yt}++E;break;case CanvasInstruction.FILL:W?w++:this.fill_(t),++E;break;case CanvasInstruction.MOVE_TO_LINE_TO:for(L=N[1],h=N[2],S=l[L],u=(y=l[L+1])+.5|0,(f=S+.5|0)===d&&u===m||(t.moveTo(S,y),d=f,m=u),L+=2;L<h;L+=2)f=(S=l[L])+.5|0,u=(y=l[L+1])+.5|0,L!=h-2&&f===d&&u===m||(t.lineTo(S,y),d=f,m=u);++E;break;case CanvasInstruction.SET_FILL_STYLE:R=N,this.alignFill_=N[2],w&&(this.fill_(t),w=0,k&&(t.stroke(),k=0)),t.fillStyle=N[1],++E;break;case CanvasInstruction.SET_STROKE_STYLE:O=N,k&&(t.stroke(),k=0),this.setStrokeStyle_(t,N),++E;break;case CanvasInstruction.STROKE:W?k++:t.stroke(),++E;break;default:++E}}w&&this.fill_(t),k&&t.stroke()},t.prototype.execute=function(t,e,i,a,r,s){this.viewRotation_=a,this.execute_(t,e,i,this.instructions,r,void 0,void 0,s)},t.prototype.executeHitDetection=function(t,e,i,a,r){return this.viewRotation_=i,this.execute_(t,1,e,this.hitDetectionInstructions,!0,a,r)},t}();export default Executor;
//# sourceMappingURL=/sm/f36476d7246efa4cf6ac5c631e3bdf95eff22f891f430f2539da969d85ffe98d.map