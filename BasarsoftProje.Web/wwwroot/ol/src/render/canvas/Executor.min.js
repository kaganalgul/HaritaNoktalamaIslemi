/**
 * Minified by jsDelivr using Terser v5.10.0.
 * Original file: /npm/ol@6.12.0/src/render/canvas/Executor.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import CanvasInstruction from"./Instruction.js";import{TEXT_ALIGN}from"./TextBuilder.js";import{WORKER_OFFSCREEN_CANVAS}from"../../has.js";import{apply as applyTransform,compose as composeTransform,create as createTransform,setFromArray as transformSetFromArray}from"../../transform.js";import{createEmpty,createOrUpdate,intersects}from"../../extent.js";import{defaultPadding,defaultTextBaseline,drawImageOrLabel}from"../canvas.js";import{defaultTextAlign,measureAndCacheTextWidth,measureTextHeight,measureTextWidths}from"../canvas.js";import{drawTextOnPath}from"../../geom/flat/textpath.js";import{equals}from"../../array.js";import{lineStringLength}from"../../geom/flat/length.js";import{transform2D}from"../../geom/flat/transform.js";const tmpExtent=createEmpty(),p1=[],p2=[],p3=[],p4=[];function getDeclutterBox(t){return t[3].declutterBox}const rtlRegEx=new RegExp("["+String.fromCharCode(1425)+"-"+String.fromCharCode(2303)+String.fromCharCode(64285)+"-"+String.fromCharCode(65023)+String.fromCharCode(65136)+"-"+String.fromCharCode(65276)+String.fromCharCode(67584)+"-"+String.fromCharCode(69631)+String.fromCharCode(124928)+"-"+String.fromCharCode(126975)+"]");function horizontalTextAlign(t,e){return"start"!==e&&"end"!==e||rtlRegEx.test(t)||(e="start"===e?"left":"right"),TEXT_ALIGN[e]}class Executor{constructor(t,e,i,a){this.overlaps=i,this.pixelRatio=e,this.resolution=t,this.alignFill_,this.instructions=a.instructions,this.coordinates=a.coordinates,this.coordinateCache_={},this.renderedTransform_=createTransform(),this.hitDetectionInstructions=a.hitDetectionInstructions,this.pixelCoordinates_=null,this.viewRotation_=0,this.fillStates=a.fillStates||{},this.strokeStates=a.strokeStates||{},this.textStates=a.textStates||{},this.widths_={},this.labels_={}}createLabel(t,e,i,a){const s=t+e+i+a;if(this.labels_[s])return this.labels_[s];const n=a?this.strokeStates[a]:null,r=i?this.fillStates[i]:null,o=this.textStates[e],l=this.pixelRatio,h=[o.scale[0]*l,o.scale[1]*l],c=horizontalTextAlign(t,o.textAlign||defaultTextAlign),p=a&&n.lineWidth?n.lineWidth:0,m=t.split("\n"),d=m.length,f=[],u=measureTextWidths(o.font,m,f),g=measureTextHeight(o.font),x=u+p,_=[],T=(x+2)*h[0],C=(g*d+p)*h[1],S={width:T<0?Math.floor(T):Math.ceil(T),height:C<0?Math.floor(C):Math.ceil(C),contextInstructions:_};if(1==h[0]&&1==h[1]||_.push("scale",h),_.push("font",o.font),a){_.push("strokeStyle",n.strokeStyle),_.push("lineWidth",p),_.push("lineCap",n.lineCap),_.push("lineJoin",n.lineJoin),_.push("miterLimit",n.miterLimit);(WORKER_OFFSCREEN_CANVAS?OffscreenCanvasRenderingContext2D:CanvasRenderingContext2D).prototype.setLineDash&&(_.push("setLineDash",[n.lineDash]),_.push("lineDashOffset",n.lineDashOffset))}i&&_.push("fillStyle",r.fillStyle),_.push("textBaseline","middle"),_.push("textAlign","center");const I=.5-c,E=c*x+I*p;let b;if(a)for(b=0;b<d;++b)_.push("strokeText",[m[b],E+I*f[b],.5*(p+g)+b*g]);if(i)for(b=0;b<d;++b)_.push("fillText",[m[b],E+I*f[b],.5*(p+g)+b*g]);return this.labels_[s]=S,S}replayTextBackground_(t,e,i,a,s,n,r){t.beginPath(),t.moveTo.apply(t,e),t.lineTo.apply(t,i),t.lineTo.apply(t,a),t.lineTo.apply(t,s),t.lineTo.apply(t,e),n&&(this.alignFill_=n[2],this.fill_(t)),r&&(this.setStrokeStyle_(t,r),t.stroke())}calculateImageOrLabelDimensions_(t,e,i,a,s,n,r,o,l,h,c,p,m,d,f,u){let g=i-(r*=p[0]),x=a-(o*=p[1]);const _=s+l>t?t-l:s,T=n+h>e?e-h:n,C=d[3]+_*p[0]+d[1],S=d[0]+T*p[1]+d[2],I=g-d[3],E=x-d[0];let b;return(f||0!==c)&&(p1[0]=I,p4[0]=I,p1[1]=E,p2[1]=E,p2[0]=I+C,p3[0]=p2[0],p3[1]=E+S,p4[1]=p3[1]),0!==c?(b=composeTransform(createTransform(),i,a,1,1,c,-i,-a),applyTransform(b,p1),applyTransform(b,p2),applyTransform(b,p3),applyTransform(b,p4),createOrUpdate(Math.min(p1[0],p2[0],p3[0],p4[0]),Math.min(p1[1],p2[1],p3[1],p4[1]),Math.max(p1[0],p2[0],p3[0],p4[0]),Math.max(p1[1],p2[1],p3[1],p4[1]),tmpExtent)):createOrUpdate(Math.min(I,I+C),Math.min(E,E+S),Math.max(I,I+C),Math.max(E,E+S),tmpExtent),m&&(g=Math.round(g),x=Math.round(x)),{drawImageX:g,drawImageY:x,drawImageW:_,drawImageH:T,originX:l,originY:h,declutterBox:{minX:tmpExtent[0],minY:tmpExtent[1],maxX:tmpExtent[2],maxY:tmpExtent[3],value:u},canvasTransform:b,scale:p}}replayImageOrLabel_(t,e,i,a,s,n,r){const o=!(!n&&!r),l=a.declutterBox,h=t.canvas,c=r?r[2]*a.scale[0]/2:0;return l.minX-c<=h.width/e&&l.maxX+c>=0&&l.minY-c<=h.height/e&&l.maxY+c>=0&&(o&&this.replayTextBackground_(t,p1,p2,p3,p4,n,r),drawImageOrLabel(t,a.canvasTransform,s,i,a.originX,a.originY,a.drawImageW,a.drawImageH,a.drawImageX,a.drawImageY,a.scale)),!0}fill_(t){if(this.alignFill_){const e=applyTransform(this.renderedTransform_,[0,0]),i=512*this.pixelRatio;t.save(),t.translate(e[0]%i,e[1]%i),t.rotate(this.viewRotation_)}t.fill(),this.alignFill_&&t.restore()}setStrokeStyle_(t,e){t.strokeStyle=e[1],t.lineWidth=e[2],t.lineCap=e[3],t.lineJoin=e[4],t.miterLimit=e[5],t.setLineDash&&(t.lineDashOffset=e[7],t.setLineDash(e[6]))}drawLabelWithPointPlacement_(t,e,i,a){const s=this.textStates[e],n=this.createLabel(t,e,a,i),r=this.strokeStates[i],o=this.pixelRatio,l=horizontalTextAlign(t,s.textAlign||defaultTextAlign),h=TEXT_ALIGN[s.textBaseline||defaultTextBaseline],c=r&&r.lineWidth?r.lineWidth:0;return{label:n,anchorX:l*(n.width/o-2*s.scale[0])+2*(.5-l)*c,anchorY:h*n.height/o+2*(.5-h)*c}}execute_(t,e,i,a,s,n,r,o){let l;this.pixelCoordinates_&&equals(i,this.renderedTransform_)?l=this.pixelCoordinates_:(this.pixelCoordinates_||(this.pixelCoordinates_=[]),l=transform2D(this.coordinates,0,this.coordinates.length,2,i,this.pixelCoordinates_),transformSetFromArray(this.renderedTransform_,i));let h=0;const c=a.length;let p,m,d,f,u,g,x,_,T,C,S,I,E=0,b=0,v=0,y=null,L=null;const w=this.coordinateCache_,k=this.viewRotation_,R=Math.round(1e12*Math.atan2(-i[1],i[0]))/1e12,O={context:t,pixelRatio:this.pixelRatio,resolution:this.resolution,rotation:k},A=this.instructions!=a||this.overlaps?0:200;let D,M,B,W;for(;h<c;){const i=a[h];switch(i[0]){case CanvasInstruction.BEGIN_GEOMETRY:D=i[1],W=i[3],D.getGeometry()?void 0===r||intersects(r,W.getExtent())?++h:h=i[2]+1:h=i[2];break;case CanvasInstruction.BEGIN_PATH:b>A&&(this.fill_(t),b=0),v>A&&(t.stroke(),v=0),b||v||(t.beginPath(),f=NaN,u=NaN),++h;break;case CanvasInstruction.CIRCLE:E=i[1];const a=l[E],c=l[E+1],N=l[E+2]-a,P=l[E+3]-c,F=Math.sqrt(N*N+P*P);t.moveTo(a+F,c),t.arc(a,c,F,0,2*Math.PI,!0),++h;break;case CanvasInstruction.CLOSE_PATH:t.closePath(),++h;break;case CanvasInstruction.CUSTOM:E=i[1],p=i[2];const X=i[3],Y=i[4],j=6==i.length?i[5]:void 0;O.geometry=X,O.feature=D,h in w||(w[h]=[]);const G=w[h];j?j(l,E,p,2,G):(G[0]=l[E],G[1]=l[E+1],G.length=2),Y(G,O),++h;break;case CanvasInstruction.DRAW_IMAGE:E=i[1],p=i[2],_=i[3],m=i[4],d=i[5];let H=i[6];const K=i[7],U=i[8],q=i[9],z=i[10];let J=i[11];const V=i[12];let Q=i[13];const Z=i[14];if(!_&&i.length>=19){T=i[18],C=i[19],S=i[20],I=i[21];const t=this.drawLabelWithPointPlacement_(T,C,S,I);_=t.label,i[3]=_;const e=i[22];m=(t.anchorX-e)*this.pixelRatio,i[4]=m;const a=i[23];d=(t.anchorY-a)*this.pixelRatio,i[5]=d,H=_.height,i[6]=H,Q=_.width,i[13]=Q}let $,tt,et,it;i.length>24&&($=i[24]),i.length>16?(tt=i[15],et=i[16],it=i[17]):(tt=defaultPadding,et=!1,it=!1),z&&R?J+=k:z||R||(J-=k);let at=0;for(;E<p;E+=2){if($&&$[at++]<Q/this.pixelRatio)continue;const i=this.calculateImageOrLabelDimensions_(_.width,_.height,l[E],l[E+1],Q,H,m,d,U,q,J,V,s,tt,et||it,D),a=[t,e,_,i,K,et?y:null,it?L:null];let n,r;if(o&&Z){const t=p-E;if(!Z[t]){Z[t]=a;continue}if(n=Z[t],delete Z[t],r=getDeclutterBox(n),o.collides(r))continue}o&&o.collides(i.declutterBox)||(n&&(o&&o.insert(r),this.replayImageOrLabel_.apply(this,n)),o&&o.insert(i.declutterBox),this.replayImageOrLabel_.apply(this,a))}++h;break;case CanvasInstruction.DRAW_CHARS:const st=i[1],nt=i[2],rt=i[3],ot=i[4];I=i[5];const lt=i[6],ht=i[7],ct=i[8];S=i[9];const pt=i[10];T=i[11],C=i[12];const mt=[i[13],i[13]],dt=this.textStates[C],ft=dt.font,ut=[dt.scale[0]*ht,dt.scale[1]*ht];let gt;ft in this.widths_?gt=this.widths_[ft]:(gt={},this.widths_[ft]=gt);const xt=lineStringLength(l,st,nt,2),_t=Math.abs(ut[0])*measureAndCacheTextWidth(ft,T,gt);if(ot||_t<=xt){const i=this.textStates[C].textAlign,a=(xt-_t)*TEXT_ALIGN[i],s=drawTextOnPath(l,st,nt,2,T,a,lt,Math.abs(ut[0]),measureAndCacheTextWidth,ft,gt,R?0:this.viewRotation_);t:if(s){const i=[];let a,n,r,l,h;if(S)for(a=0,n=s.length;a<n;++a){h=s[a],r=h[4],l=this.createLabel(r,C,"",S),m=h[2]+(ut[0]<0?-pt:pt),d=rt*l.height+2*(.5-rt)*pt*ut[1]/ut[0]-ct;const n=this.calculateImageOrLabelDimensions_(l.width,l.height,h[0],h[1],l.width,l.height,m,d,0,0,h[3],mt,!1,defaultPadding,!1,D);if(o&&o.collides(n.declutterBox))break t;i.push([t,e,l,n,1,null,null])}if(I)for(a=0,n=s.length;a<n;++a){h=s[a],r=h[4],l=this.createLabel(r,C,I,""),m=h[2],d=rt*l.height-ct;const n=this.calculateImageOrLabelDimensions_(l.width,l.height,h[0],h[1],l.width,l.height,m,d,0,0,h[3],mt,!1,defaultPadding,!1,D);if(o&&o.collides(n.declutterBox))break t;i.push([t,e,l,n,1,null,null])}o&&o.load(i.map(getDeclutterBox));for(let t=0,e=i.length;t<e;++t)this.replayImageOrLabel_.apply(this,i[t])}}++h;break;case CanvasInstruction.END_GEOMETRY:if(void 0!==n){D=i[1];const t=n(D,W);if(t)return t}++h;break;case CanvasInstruction.FILL:A?b++:this.fill_(t),++h;break;case CanvasInstruction.MOVE_TO_LINE_TO:for(E=i[1],p=i[2],M=l[E],B=l[E+1],g=M+.5|0,x=B+.5|0,g===f&&x===u||(t.moveTo(M,B),f=g,u=x),E+=2;E<p;E+=2)M=l[E],B=l[E+1],g=M+.5|0,x=B+.5|0,E!=p-2&&g===f&&x===u||(t.lineTo(M,B),f=g,u=x);++h;break;case CanvasInstruction.SET_FILL_STYLE:y=i,this.alignFill_=i[2],b&&(this.fill_(t),b=0,v&&(t.stroke(),v=0)),t.fillStyle=i[1],++h;break;case CanvasInstruction.SET_STROKE_STYLE:L=i,v&&(t.stroke(),v=0),this.setStrokeStyle_(t,i),++h;break;case CanvasInstruction.STROKE:A?v++:t.stroke(),++h;break;default:++h}}b&&this.fill_(t),v&&t.stroke()}execute(t,e,i,a,s,n){this.viewRotation_=a,this.execute_(t,e,i,this.instructions,s,void 0,void 0,n)}executeHitDetection(t,e,i,a,s){return this.viewRotation_=i,this.execute_(t,1,e,this.hitDetectionInstructions,!0,a,s)}}export default Executor;
//# sourceMappingURL=/sm/914a9016e689d9d94f45f909a482f37da1e713e09c20647e46f53e0948ad8468.map