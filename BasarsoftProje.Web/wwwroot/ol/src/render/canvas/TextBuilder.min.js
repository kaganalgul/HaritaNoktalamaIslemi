/**
 * Minified by jsDelivr using Terser v5.10.0.
 * Original file: /npm/ol@6.12.0/src/render/canvas/TextBuilder.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import CanvasBuilder from"./Builder.js";import CanvasInstruction from"./Instruction.js";import GeometryType from"../../geom/GeometryType.js";import TextPlacement from"../../style/TextPlacement.js";import{asColorLike}from"../../colorlike.js";import{defaultFillStyle,defaultFont,defaultLineCap,defaultLineDash,defaultLineDashOffset,defaultLineJoin,defaultLineWidth,defaultMiterLimit,defaultPadding,defaultStrokeStyle,defaultTextAlign,defaultTextBaseline,registerFont}from"../canvas.js";import{getUid}from"../../util.js";import{intersects}from"../../extent.js";import{matchingChunk}from"../../geom/flat/straightchunk.js";export const TEXT_ALIGN={left:0,end:0,center:.5,right:1,start:1,top:0,middle:.5,hanging:.2,alphabetic:.8,ideographic:.8,bottom:1};class CanvasTextBuilder extends CanvasBuilder{constructor(t,e,i,s){super(t,e,i,s),this.labels_=null,this.text_="",this.textOffsetX_=0,this.textOffsetY_=0,this.textRotateWithView_=void 0,this.textRotation_=0,this.textFillState_=null,this.fillStates={},this.textStrokeState_=null,this.strokeStates={},this.textState_={},this.textStates={},this.textKey_="",this.fillKey_="",this.strokeKey_="",this.declutterImageWithText_=void 0}finish(){const t=super.finish();return t.textStates=this.textStates,t.fillStates=this.fillStates,t.strokeStates=this.strokeStates,t}drawText(t,e){const i=this.textFillState_,s=this.textStrokeState_,l=this.textState_;if(""===this.text_||!l||!i&&!s)return;const a=this.coordinates;let n=a.length;const o=t.getType();let r=null,h=t.getStride();if(l.placement!==TextPlacement.LINE||o!=GeometryType.LINE_STRING&&o!=GeometryType.MULTI_LINE_STRING&&o!=GeometryType.POLYGON&&o!=GeometryType.MULTI_POLYGON){let i=l.overflow?null:[];switch(o){case GeometryType.POINT:case GeometryType.MULTI_POINT:r=t.getFlatCoordinates();break;case GeometryType.LINE_STRING:r=t.getFlatMidpoint();break;case GeometryType.CIRCLE:r=t.getCenter();break;case GeometryType.MULTI_LINE_STRING:r=t.getFlatMidpoints(),h=2;break;case GeometryType.POLYGON:r=t.getFlatInteriorPoint(),l.overflow||i.push(r[2]/this.resolution),h=3;break;case GeometryType.MULTI_POLYGON:const e=t.getFlatInteriorPoints();r=[];for(let t=0,s=e.length;t<s;t+=3)l.overflow||i.push(e[t+2]/this.resolution),r.push(e[t],e[t+1]);if(0===r.length)return;h=2}const s=this.appendFlatPointCoordinates(r,h);if(s===n)return;if(i&&(s-n)/2!=r.length/h){let t=n/2;i=i.filter(((e,i)=>{const s=a[2*(t+i)]===r[i*h]&&a[2*(t+i)+1]===r[i*h+1];return s||--t,s}))}this.saveTextStates_(),(l.backgroundFill||l.backgroundStroke)&&(this.setFillStrokeStyle(l.backgroundFill,l.backgroundStroke),l.backgroundFill&&(this.updateFillStyle(this.state,this.createFill),this.hitDetectionInstructions.push(this.createFill(this.state))),l.backgroundStroke&&(this.updateStrokeStyle(this.state,this.applyStroke),this.hitDetectionInstructions.push(this.createStroke(this.state)))),this.beginGeometry(t,e);let f=l.padding;if(f!=defaultPadding&&(l.scale[0]<0||l.scale[1]<0)){let t=l.padding[0],e=l.padding[1],i=l.padding[2],s=l.padding[3];l.scale[0]<0&&(e=-e,s=-s),l.scale[1]<0&&(t=-t,i=-i),f=[t,e,i,s]}const d=this.pixelRatio;this.instructions.push([CanvasInstruction.DRAW_IMAGE,n,s,null,NaN,NaN,NaN,1,0,0,this.textRotateWithView_,this.textRotation_,[1,1],NaN,this.declutterImageWithText_,f==defaultPadding?defaultPadding:f.map((function(t){return t*d})),!!l.backgroundFill,!!l.backgroundStroke,this.text_,this.textKey_,this.strokeKey_,this.fillKey_,this.textOffsetX_,this.textOffsetY_,i]);const g=1/d;this.hitDetectionInstructions.push([CanvasInstruction.DRAW_IMAGE,n,s,null,NaN,NaN,NaN,1,0,0,this.textRotateWithView_,this.textRotation_,[g,g],NaN,this.declutterImageWithText_,f,!!l.backgroundFill,!!l.backgroundStroke,this.text_,this.textKey_,this.strokeKey_,this.fillKey_,this.textOffsetX_,this.textOffsetY_,i]),this.endGeometry(e)}else{if(!intersects(this.getBufferedMaxExtent(),t.getExtent()))return;let i;if(r=t.getFlatCoordinates(),o==GeometryType.LINE_STRING)i=[r.length];else if(o==GeometryType.MULTI_LINE_STRING)i=t.getEnds();else if(o==GeometryType.POLYGON)i=t.getEnds().slice(0,1);else if(o==GeometryType.MULTI_POLYGON){const e=t.getEndss();i=[];for(let t=0,s=e.length;t<s;++t)i.push(e[t][0])}this.beginGeometry(t,e);const s=l.textAlign;let f,d=0;for(let t=0,e=i.length;t<e;++t){if(null==s){const e=matchingChunk(l.maxAngle,r,d,i[t],h);d=e[0],f=e[1]}else f=i[t];for(let t=d;t<f;t+=h)a.push(r[t],r[t+1]);const e=a.length;d=i[t],this.drawChars_(n,e),n=e}this.endGeometry(e)}}saveTextStates_(){const t=this.textStrokeState_,e=this.textState_,i=this.textFillState_,s=this.strokeKey_;t&&(s in this.strokeStates||(this.strokeStates[s]={strokeStyle:t.strokeStyle,lineCap:t.lineCap,lineDashOffset:t.lineDashOffset,lineWidth:t.lineWidth,lineJoin:t.lineJoin,miterLimit:t.miterLimit,lineDash:t.lineDash}));const l=this.textKey_;l in this.textStates||(this.textStates[l]={font:e.font,textAlign:e.textAlign||defaultTextAlign,textBaseline:e.textBaseline||defaultTextBaseline,scale:e.scale});const a=this.fillKey_;i&&(a in this.fillStates||(this.fillStates[a]={fillStyle:i.fillStyle}))}drawChars_(t,e){const i=this.textStrokeState_,s=this.textState_,l=this.strokeKey_,a=this.textKey_,n=this.fillKey_;this.saveTextStates_();const o=this.pixelRatio,r=TEXT_ALIGN[s.textBaseline],h=this.textOffsetY_*o,f=this.text_,d=i?i.lineWidth*Math.abs(s.scale[0])/2:0;this.instructions.push([CanvasInstruction.DRAW_CHARS,t,e,r,s.overflow,n,s.maxAngle,o,h,l,d*o,f,a,1]),this.hitDetectionInstructions.push([CanvasInstruction.DRAW_CHARS,t,e,r,s.overflow,n,s.maxAngle,1,h,l,d,f,a,1/o])}setTextStyle(t,e){let i,s,l;if(t){const e=t.getFill();e?(s=this.textFillState_,s||(s={},this.textFillState_=s),s.fillStyle=asColorLike(e.getColor()||defaultFillStyle)):(s=null,this.textFillState_=s);const a=t.getStroke();if(a){l=this.textStrokeState_,l||(l={},this.textStrokeState_=l);const t=a.getLineDash(),e=a.getLineDashOffset(),i=a.getWidth(),s=a.getMiterLimit();l.lineCap=a.getLineCap()||defaultLineCap,l.lineDash=t?t.slice():defaultLineDash,l.lineDashOffset=void 0===e?defaultLineDashOffset:e,l.lineJoin=a.getLineJoin()||defaultLineJoin,l.lineWidth=void 0===i?defaultLineWidth:i,l.miterLimit=void 0===s?defaultMiterLimit:s,l.strokeStyle=asColorLike(a.getColor()||defaultStrokeStyle)}else l=null,this.textStrokeState_=l;i=this.textState_;const n=t.getFont()||defaultFont;registerFont(n);const o=t.getScaleArray();i.overflow=t.getOverflow(),i.font=n,i.maxAngle=t.getMaxAngle(),i.placement=t.getPlacement(),i.textAlign=t.getTextAlign(),i.textBaseline=t.getTextBaseline()||defaultTextBaseline,i.backgroundFill=t.getBackgroundFill(),i.backgroundStroke=t.getBackgroundStroke(),i.padding=t.getPadding()||defaultPadding,i.scale=void 0===o?[1,1]:o;const r=t.getOffsetX(),h=t.getOffsetY(),f=t.getRotateWithView(),d=t.getRotation();this.text_=t.getText()||"",this.textOffsetX_=void 0===r?0:r,this.textOffsetY_=void 0===h?0:h,this.textRotateWithView_=void 0!==f&&f,this.textRotation_=void 0===d?0:d,this.strokeKey_=l?("string"==typeof l.strokeStyle?l.strokeStyle:getUid(l.strokeStyle))+l.lineCap+l.lineDashOffset+"|"+l.lineWidth+l.lineJoin+l.miterLimit+"["+l.lineDash.join()+"]":"",this.textKey_=i.font+i.scale+(i.textAlign||"?")+(i.textBaseline||"?"),this.fillKey_=s?"string"==typeof s.fillStyle?s.fillStyle:"|"+getUid(s.fillStyle):""}else this.text_="";this.declutterImageWithText_=e}}export default CanvasTextBuilder;
//# sourceMappingURL=/sm/277c472eb9dd7a99f21aac762fec5085946c61f39515fef7affa6e2685467fb8.map