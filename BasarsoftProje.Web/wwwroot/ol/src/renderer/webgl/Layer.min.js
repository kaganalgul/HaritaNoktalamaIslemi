/**
 * Minified by jsDelivr using Terser v5.10.0.
 * Original file: /npm/ol@6.12.0/src/renderer/webgl/Layer.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import LayerProperty from"../../layer/Property.js";import LayerRenderer from"../Layer.js";import RenderEvent from"../../render/Event.js";import RenderEventType from"../../render/EventType.js";import WebGLHelper from"../../webgl/Helper.js";import{apply as applyTransform,compose as composeTransform,create as createTransform}from"../../transform.js";import{containsCoordinate}from"../../extent.js";export const WebGLWorkerMessageType={GENERATE_BUFFERS:"GENERATE_BUFFERS"};class WebGLLayerRenderer extends LayerRenderer{constructor(e,t){super(e);const r=t||{};this.inversePixelTransform_=createTransform(),this.pixelContext_=null,this.postProcesses_=r.postProcesses,this.uniforms_=r.uniforms,this.helper,e.addChangeListener(LayerProperty.MAP,this.removeHelper_.bind(this)),this.dispatchPreComposeEvent=this.dispatchPreComposeEvent.bind(this),this.dispatchPostComposeEvent=this.dispatchPostComposeEvent.bind(this)}dispatchPreComposeEvent(e,t){const r=this.getLayer();if(r.hasListener(RenderEventType.PRECOMPOSE)){const n=new RenderEvent(RenderEventType.PRECOMPOSE,void 0,t,e);r.dispatchEvent(n)}}dispatchPostComposeEvent(e,t){const r=this.getLayer();if(r.hasListener(RenderEventType.POSTCOMPOSE)){const n=new RenderEvent(RenderEventType.POSTCOMPOSE,void 0,t,e);r.dispatchEvent(n)}}reset(e){this.uniforms_=e.uniforms,this.helper&&this.helper.setUniforms(this.uniforms_)}removeHelper_(){this.helper&&(this.helper.dispose(),delete this.helper)}prepareFrame(e){if(this.getLayer().getSource()){let t,r=!0,n=-1;for(let s=0,o=e.layerStatesArray.length;s<o;s++){const o=e.layerStatesArray[s].layer,i=o.getRenderer();if(!(i instanceof WebGLLayerRenderer)){r=!0;continue}const a=o.getClassName();if((r||a!==t)&&(n+=1,r=!1),t=a,i===this)break}const s="map/"+e.mapId+"/group/"+n;this.helper&&this.helper.canvasCacheKeyMatches(s)||(this.helper&&this.helper.dispose(),this.helper=new WebGLHelper({postProcesses:this.postProcesses_,uniforms:this.uniforms_,canvasCacheKey:s}),t&&(this.helper.getCanvas().className=t),this.afterHelperCreated())}return this.prepareFrameInternal(e)}afterHelperCreated(){}prepareFrameInternal(e){return!0}disposeInternal(){this.removeHelper_(),super.disposeInternal()}dispatchRenderEvent_(e,t,r){const n=this.getLayer();if(n.hasListener(e)){composeTransform(this.inversePixelTransform_,0,0,r.pixelRatio,-r.pixelRatio,0,0,-r.size[1]);const s=new RenderEvent(e,this.inversePixelTransform_,r,t);n.dispatchEvent(s)}}preRender(e,t){this.dispatchRenderEvent_(RenderEventType.PRERENDER,e,t)}postRender(e,t){this.dispatchRenderEvent_(RenderEventType.POSTRENDER,e,t)}getDataAtPixel(e,t,r){const n=applyTransform([t.pixelRatio,0,0,t.pixelRatio,0,0],e.slice()),s=this.helper.getGL();if(!s)return null;const o=this.getLayer().getExtent();if(o){const r=applyTransform(t.pixelToCoordinateTransform,e.slice());if(!containsCoordinate(o,r))return null}const i=s.getContextAttributes();if(!i||!i.preserveDrawingBuffer)return new Uint8Array;const a=Math.round(n[0]),p=Math.round(n[1]);let h,l=this.pixelContext_;if(!l){const e=document.createElement("canvas");e.width=1,e.height=1,l=e.getContext("2d"),this.pixelContext_=l}l.clearRect(0,0,1,1);try{l.drawImage(s.canvas,a,p,1,1,0,0,1,1),h=l.getImageData(0,0,1,1).data}catch(e){return h}return 0===h[3]?null:h}}const tmpArray_=[],bufferPositions_={vertexPosition:0,indexPosition:0};function writePointVertex(e,t,r,n,s){e[t+0]=r,e[t+1]=n,e[t+2]=s}export function writePointFeatureToBuffers(e,t,r,n,s,o){const i=3+s,a=e[t+0],p=e[t+1],h=tmpArray_;h.length=s;for(let r=0;r<h.length;r++)h[r]=e[t+2+r];let l=o?o.vertexPosition:0,c=o?o.indexPosition:0;const d=l/i;return writePointVertex(r,l,a,p,0),h.length&&r.set(h,l+3),l+=i,writePointVertex(r,l,a,p,1),h.length&&r.set(h,l+3),l+=i,writePointVertex(r,l,a,p,2),h.length&&r.set(h,l+3),l+=i,writePointVertex(r,l,a,p,3),h.length&&r.set(h,l+3),l+=i,n[c++]=d,n[c++]=d+1,n[c++]=d+3,n[c++]=d+1,n[c++]=d+2,n[c++]=d+3,bufferPositions_.vertexPosition=l,bufferPositions_.indexPosition=c,bufferPositions_}export function getBlankImageData(){const e=document.createElement("canvas").getContext("2d").createImageData(1,1);return e.data[0]=255,e.data[1]=255,e.data[2]=255,e.data[3]=255,e}export function colorEncodeId(e,t){const r=t||[],n=256,s=255;return r[0]=Math.floor(e/n/n/n)/s,r[1]=Math.floor(e/n/n)%n/s,r[2]=Math.floor(e/n)%n/s,r[3]=e%n/s,r}export function colorDecodeId(e){let t=0;const r=256,n=255;return t+=Math.round(e[0]*r*r*r*n),t+=Math.round(e[1]*r*r*n),t+=Math.round(e[2]*r*n),t+=Math.round(e[3]*n),t}export default WebGLLayerRenderer;
//# sourceMappingURL=/sm/dd7140334f12dcb6d6690c0314051afa7bd63f2495d2b3218d2a861eb952a413.map