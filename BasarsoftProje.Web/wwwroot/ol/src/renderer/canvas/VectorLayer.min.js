/**
 * Minified by jsDelivr using Terser v5.10.0.
 * Original file: /npm/ol@6.12.0/src/renderer/canvas/VectorLayer.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import CanvasBuilderGroup from"../../render/canvas/BuilderGroup.js";import CanvasLayerRenderer from"./Layer.js";import ExecutorGroup from"../../render/canvas/ExecutorGroup.js";import ViewHint from"../../ViewHint.js";import{HIT_DETECT_RESOLUTION,createHitDetectionImageData,hitDetect}from"../../render/canvas/hitdetect.js";import{apply,makeInverse,makeScale,toString as transformToString}from"../../transform.js";import{buffer,containsExtent,createEmpty,getWidth,intersects as intersectsExtent,wrapX as wrapExtentX}from"../../extent.js";import{cssOpacity}from"../../css.js";import{defaultOrder as defaultRenderOrder,getTolerance as getRenderTolerance,getSquaredTolerance as getSquaredRenderTolerance,renderFeature}from"../vector.js";import{equals}from"../../array.js";import{fromUserExtent,getTransformFromProjections,getUserProjection,toUserExtent,toUserResolution}from"../../proj.js";import{getUid}from"../../util.js";import{wrapX as wrapCoordinateX}from"../../coordinate.js";class CanvasVectorLayerRenderer extends CanvasLayerRenderer{constructor(e){super(e),this.boundHandleStyleImageChange_=this.handleStyleImageChange_.bind(this),this.animatingOrInteracting_,this.dirty_=!1,this.hitDetectionImageData_=null,this.renderedFeatures_=null,this.renderedRevision_=-1,this.renderedResolution_=NaN,this.renderedExtent_=createEmpty(),this.wrappedRenderedExtent_=createEmpty(),this.renderedRotation_,this.renderedCenter_=null,this.renderedProjection_=null,this.renderedRenderOrder_=null,this.replayGroup_=null,this.replayGroupChanged=!0,this.declutterExecutorGroup=null,this.clipping=!0}renderWorlds(e,t,r){const n=t.extent,i=t.viewState,s=i.center,o=i.resolution,a=i.projection,d=i.rotation,c=a.getExtent(),h=this.getLayer().getSource(),l=t.pixelRatio,u=t.viewHints,p=!(u[ViewHint.ANIMATING]||u[ViewHint.INTERACTING]),g=this.context,m=Math.round(t.size[0]*l),f=Math.round(t.size[1]*l),_=h.getWrapX()&&a.canWrapX(),E=_?getWidth(c):null,x=_?Math.ceil((n[2]-c[2])/E)+1:1;let y=_?Math.floor((n[0]-c[0])/E):0;do{const t=this.getRenderTransform(s,o,d,l,m,f,y*E);e.execute(g,1,t,d,p,void 0,r)}while(++y<x)}renderDeclutter(e){this.declutterExecutorGroup&&this.renderWorlds(this.declutterExecutorGroup,e,e.declutterTree)}renderFrame(e,t){const r=e.pixelRatio,n=e.layerStatesArray[e.layerIndex];makeScale(this.pixelTransform,1/r,1/r),makeInverse(this.inversePixelTransform,this.pixelTransform);const i=transformToString(this.pixelTransform);this.useContainer(t,i,n.opacity,this.getBackground(e));const s=this.context,o=s.canvas,a=this.replayGroup_,d=this.declutterExecutorGroup;if((!a||a.isEmpty())&&(!d||d.isEmpty()))return null;const c=Math.round(e.size[0]*r),h=Math.round(e.size[1]*r);o.width!=c||o.height!=h?(o.width=c,o.height=h,o.style.transform!==i&&(o.style.transform=i)):this.containerReused||s.clearRect(0,0,c,h),this.preRender(s,e);const l=e.viewState,u=l.projection;let p=!1,g=!0;if(n.extent&&this.clipping){const t=fromUserExtent(n.extent,u);g=intersectsExtent(t,e.extent),p=g&&!containsExtent(t,e.extent),p&&this.clipUnrotated(s,e,t)}g&&this.renderWorlds(a,e),p&&s.restore(),this.postRender(s,e);const m=cssOpacity(n.opacity),f=this.container;return m!==f.style.opacity&&(f.style.opacity=m),this.renderedRotation_!==l.rotation&&(this.renderedRotation_=l.rotation,this.hitDetectionImageData_=null),this.container}getFeatures(e){return new Promise(function(t){if(!this.hitDetectionImageData_&&!this.animatingOrInteracting_){const e=[this.context.canvas.width,this.context.canvas.height];apply(this.pixelTransform,e);const t=this.renderedCenter_,r=this.renderedResolution_,n=this.renderedRotation_,i=this.renderedProjection_,s=this.wrappedRenderedExtent_,o=this.getLayer(),a=[],d=e[0]*HIT_DETECT_RESOLUTION,c=e[1]*HIT_DETECT_RESOLUTION;a.push(this.getRenderTransform(t,r,n,HIT_DETECT_RESOLUTION,d,c,0).slice());const h=o.getSource(),l=i.getExtent();if(h.getWrapX()&&i.canWrapX()&&!containsExtent(l,s)){let e=s[0];const i=getWidth(l);let o,h=0;for(;e<l[0];)--h,o=i*h,a.push(this.getRenderTransform(t,r,n,HIT_DETECT_RESOLUTION,d,c,o).slice()),e+=i;for(h=0,e=s[2];e>l[2];)++h,o=i*h,a.push(this.getRenderTransform(t,r,n,HIT_DETECT_RESOLUTION,d,c,o).slice()),e-=i}this.hitDetectionImageData_=createHitDetectionImageData(e,a,this.renderedFeatures_,o.getStyleFunction(),s,r,n)}t(hitDetect(e,this.renderedFeatures_,this.hitDetectionImageData_))}.bind(this))}forEachFeatureAtCoordinate(e,t,r,n,i){if(!this.replayGroup_)return;const s=t.viewState.resolution,o=t.viewState.rotation,a=this.getLayer(),d={},c=function(e,t,r){const s=getUid(e),o=d[s];if(o){if(!0!==o&&r<o.distanceSq){if(0===r)return d[s]=!0,i.splice(i.lastIndexOf(o),1),n(e,a,t);o.geometry=t,o.distanceSq=r}}else{if(0===r)return d[s]=!0,n(e,a,t);i.push(d[s]={feature:e,layer:a,geometry:t,distanceSq:r,callback:n})}};let h;const l=[this.replayGroup_];return this.declutterExecutorGroup&&l.push(this.declutterExecutorGroup),l.some((n=>h=n.forEachFeatureAtCoordinate(e,s,o,r,c,n===this.declutterExecutorGroup&&t.declutterTree?t.declutterTree.all().map((e=>e.value)):null))),h}handleFontsChanged(){const e=this.getLayer();e.getVisible()&&this.replayGroup_&&e.changed()}handleStyleImageChange_(e){this.renderIfReadyAndVisible()}prepareFrame(e){const t=this.getLayer(),r=t.getSource();if(!r)return!1;const n=e.viewHints[ViewHint.ANIMATING],i=e.viewHints[ViewHint.INTERACTING],s=t.getUpdateWhileAnimating(),o=t.getUpdateWhileInteracting();if(!this.dirty_&&!s&&n||!o&&i)return this.animatingOrInteracting_=!0,!0;this.animatingOrInteracting_=!1;const a=e.extent,d=e.viewState,c=d.projection,h=d.resolution,l=e.pixelRatio,u=t.getRevision(),p=t.getRenderBuffer();let g=t.getRenderOrder();void 0===g&&(g=defaultRenderOrder);const m=d.center.slice(),f=buffer(a,p*h),_=f.slice(),E=[f.slice()],x=c.getExtent();if(r.getWrapX()&&c.canWrapX()&&!containsExtent(x,e.extent)){const e=getWidth(x),t=Math.max(getWidth(f)/2,e);f[0]=x[0]-t,f[2]=x[2]+t,wrapCoordinateX(m,c);const r=wrapExtentX(E[0],c);r[0]<x[0]&&r[2]<x[2]?E.push([r[0]+e,r[1],r[2]+e,r[3]]):r[0]>x[0]&&r[2]>x[2]&&E.push([r[0]-e,r[1],r[2]-e,r[3]])}if(!this.dirty_&&this.renderedResolution_==h&&this.renderedRevision_==u&&this.renderedRenderOrder_==g&&containsExtent(this.wrappedRenderedExtent_,f))return equals(this.renderedExtent_,_)||(this.hitDetectionImageData_=null,this.renderedExtent_=_),this.renderedCenter_=m,this.replayGroupChanged=!1,!0;this.replayGroup_=null,this.dirty_=!1;const y=new CanvasBuilderGroup(getRenderTolerance(h,l),f,h,l);let R;this.getLayer().getDeclutter()&&(R=new CanvasBuilderGroup(getRenderTolerance(h,l),f,h,l));const T=getUserProjection();let I;if(T){for(let e=0,t=E.length;e<t;++e){const t=E[e],n=toUserExtent(t,c);r.loadFeatures(n,toUserResolution(h,c),T)}I=getTransformFromProjections(T,c)}else for(let e=0,t=E.length;e<t;++e)r.loadFeatures(E[e],h,c);const v=getSquaredRenderTolerance(h,l),S=function(e){let r;const n=e.getStyleFunction()||t.getStyleFunction();if(n&&(r=n(e,h)),r){const t=this.renderFeature(e,v,r,y,I,R);this.dirty_=this.dirty_||t}}.bind(this),w=toUserExtent(f,c),C=r.getFeaturesInExtent(w);g&&C.sort(g);for(let e=0,t=C.length;e<t;++e)S(C[e]);this.renderedFeatures_=C;const G=y.finish(),D=new ExecutorGroup(f,h,l,r.getOverlaps(),G,t.getRenderBuffer());return R&&(this.declutterExecutorGroup=new ExecutorGroup(f,h,l,r.getOverlaps(),R.finish(),t.getRenderBuffer())),this.renderedResolution_=h,this.renderedRevision_=u,this.renderedRenderOrder_=g,this.renderedExtent_=_,this.wrappedRenderedExtent_=f,this.renderedCenter_=m,this.renderedProjection_=c,this.replayGroup_=D,this.hitDetectionImageData_=null,this.replayGroupChanged=!0,!0}renderFeature(e,t,r,n,i,s){if(!r)return!1;let o=!1;if(Array.isArray(r))for(let a=0,d=r.length;a<d;++a)o=renderFeature(n,e,r[a],t,this.boundHandleStyleImageChange_,i,s)||o;else o=renderFeature(n,e,r,t,this.boundHandleStyleImageChange_,i,s);return o}}export default CanvasVectorLayerRenderer;
//# sourceMappingURL=/sm/0fae801f3fbf8bf5d79c0c2e73851f5135b06dfda07b881076590416b4540e03.map