/**
 * Minified by jsDelivr using Terser v5.10.0.
 * Original file: /npm/ol@6.12.0/src/source/Raster.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import Disposable from"../Disposable.js";import Event from"../events/Event.js";import EventType from"../events/EventType.js";import ImageCanvas from"../ImageCanvas.js";import ImageLayer from"../layer/Image.js";import ImageSource from"./Image.js";import Source from"./Source.js";import SourceState from"./State.js";import TileLayer from"../layer/Tile.js";import TileQueue from"../TileQueue.js";import TileSource from"./Tile.js";import{assign}from"../obj.js";import{createCanvasContext2D}from"../dom.js";import{create as createTransform}from"../transform.js";import{equals,getCenter,getHeight,getWidth}from"../extent.js";import{getUid}from"../util.js";let context,hasImageData=!0;try{new ImageData(10,10)}catch(e){hasImageData=!1}export function newImageData(e,t,r){if(hasImageData)return new ImageData(e,t,r);context||(context=document.createElement("canvas").getContext("2d"));const s=context.createImageData(t,r);return s.data.set(e),s}function createMinion(e){let t=!0;try{new ImageData(10,10)}catch(e){t=!1}function r(e,r,s){return t?new ImageData(e,r,s):{data:e,width:r,height:s}}return function(t){const s=t.buffers,a=t.meta,n=t.imageOps,i=t.width,o=t.height,u=s.length,h=s[0].byteLength;if(n){const t=new Array(u);for(let e=0;e<u;++e)t[e]=r(new Uint8ClampedArray(s[e]),i,o);return e(t,a).data.buffer}const c=new Uint8ClampedArray(h),l=new Array(u),d=new Array(u);for(let e=0;e<u;++e)l[e]=new Uint8ClampedArray(s[e]),d[e]=[0,0,0,0];for(let t=0;t<h;t+=4){for(let e=0;e<u;++e){const r=l[e];d[e][0]=r[t],d[e][1]=r[t+1],d[e][2]=r[t+2],d[e][3]=r[t+3]}const r=e(d,a);c[t]=r[0],c[t+1]=r[1],c[t+2]=r[2],c[t+3]=r[3]}return c.buffer}}function createWorker(e,t){const r=Object.keys(e.lib||{}).map((function(t){return"var "+t+" = "+e.lib[t].toString()+";"})).concat(["var __minion__ = ("+createMinion.toString()+")(",e.operation.toString(),");",'self.addEventListener("message", function(event) {',"  var buffer = __minion__(event.data);","  self.postMessage({buffer: buffer, meta: event.data.meta}, [buffer]);","});"]),s=new Worker("undefined"==typeof Blob?"data:text/javascript;base64,"+Buffer.from(r.join("\n"),"binary").toString("base64"):URL.createObjectURL(new Blob(r,{type:"text/javascript"})));return s.addEventListener("message",t),s}function createFauxWorker(e,t){const r=createMinion(e.operation);let s=!1;return{postMessage:function(e){setTimeout((function(){s||t({data:{buffer:r(e),meta:e.meta}})}),0)},terminate:function(){s=!0}}}export class Processor extends Disposable{constructor(e){let t;super(),this._imageOps=!!e.imageOps,t=0===e.threads?0:this._imageOps?1:e.threads||1;const r=new Array(t);if(t)for(let s=0;s<t;++s)r[s]=createWorker(e,this._onWorkerMessage.bind(this,s));else r[0]=createFauxWorker(e,this._onWorkerMessage.bind(this,0));this._workers=r,this._queue=[],this._maxQueueLength=e.queue||1/0,this._running=0,this._dataLookup={},this._job=null}process(e,t,r){this._enqueue({inputs:e,meta:t,callback:r}),this._dispatch()}_enqueue(e){for(this._queue.push(e);this._queue.length>this._maxQueueLength;)this._queue.shift().callback(null,null)}_dispatch(){if(this._running||0===this._queue.length)return;const e=this._queue.shift();this._job=e;const t=e.inputs[0].width,r=e.inputs[0].height,s=e.inputs.map((function(e){return e.data.buffer})),a=this._workers.length;if(this._running=a,1===a)return void this._workers[0].postMessage({buffers:s,meta:e.meta,imageOps:this._imageOps,width:t,height:r},s);const n=e.inputs[0].data.length,i=4*Math.ceil(n/4/a);for(let n=0;n<a;++n){const a=n*i,o=[];for(let e=0,t=s.length;e<t;++e)o.push(s[e].slice(a,a+i));this._workers[n].postMessage({buffers:o,meta:e.meta,imageOps:this._imageOps,width:t,height:r},o)}}_onWorkerMessage(e,t){this.disposed||(this._dataLookup[e]=t.data,--this._running,0===this._running&&this._resolveJob())}_resolveJob(){const e=this._job,t=this._workers.length;let r,s;if(1===t)r=new Uint8ClampedArray(this._dataLookup[0].buffer),s=this._dataLookup[0].meta;else{const a=e.inputs[0].data.length;r=new Uint8ClampedArray(a),s=new Array(t);const n=4*Math.ceil(a/4/t);for(let e=0;e<t;++e){const t=this._dataLookup[e].buffer,a=e*n;r.set(new Uint8ClampedArray(t),a),s[e]=this._dataLookup[e].meta}}this._job=null,this._dataLookup={},e.callback(null,newImageData(r,e.inputs[0].width,e.inputs[0].height),s),this._dispatch()}disposeInternal(){for(let e=0;e<this._workers.length;++e)this._workers[e].terminate();this._workers.length=0}}const RasterEventType={BEFOREOPERATIONS:"beforeoperations",AFTEROPERATIONS:"afteroperations"},RasterOperationType={PIXEL:"pixel",IMAGE:"image"};export class RasterSourceEvent extends Event{constructor(e,t,r){super(e),this.extent=t.extent,this.resolution=t.viewState.resolution/t.pixelRatio,this.data=r}}class RasterSource extends ImageSource{constructor(e){super({projection:null}),this.on,this.once,this.un,this.processor_=null,this.operationType_=void 0!==e.operationType?e.operationType:RasterOperationType.PIXEL,this.threads_=void 0!==e.threads?e.threads:1,this.layers_=createLayers(e.sources);const t=this.changed.bind(this);for(let e=0,r=this.layers_.length;e<r;++e)this.layers_[e].addEventListener(EventType.CHANGE,t);this.tileQueue_=new TileQueue((function(){return 1}),this.changed.bind(this)),this.requestedFrameState_,this.renderedImageCanvas_=null,this.renderedRevision_,this.frameState_={animate:!1,coordinateToPixelTransform:createTransform(),declutterTree:null,extent:null,index:0,layerIndex:0,layerStatesArray:getLayerStatesArray(this.layers_),pixelRatio:1,pixelToCoordinateTransform:createTransform(),postRenderFunctions:[],size:[0,0],tileQueue:this.tileQueue_,time:Date.now(),usedTiles:{},viewState:{rotation:0},viewHints:[],wantedTiles:{},mapId:getUid(this),renderTargets:{}},this.setAttributions((function(t){const r=[];for(let s=0,a=e.sources.length;s<a;++s){const a=e.sources[s],n=(a instanceof Source?a:a.getSource()).getAttributions();if("function"==typeof n){const e=n(t);r.push.apply(r,e)}}return 0!==r.length?r:null})),void 0!==e.operation&&this.setOperation(e.operation,e.lib)}setOperation(e,t){this.processor_&&this.processor_.dispose(),this.processor_=new Processor({operation:e,imageOps:this.operationType_===RasterOperationType.IMAGE,queue:1,lib:t,threads:this.threads_}),this.changed()}updateFrameState_(e,t,r){const s=assign({},this.frameState_);s.viewState=assign({},s.viewState);const a=getCenter(e);s.extent=e.slice(),s.size[0]=Math.round(getWidth(e)/t),s.size[1]=Math.round(getHeight(e)/t),s.time=Date.now();const n=s.viewState;return n.center=a,n.projection=r,n.resolution=t,s}allSourcesReady_(){let e,t=!0;for(let r=0,s=this.layers_.length;r<s;++r)if(e=this.layers_[r].getSource(),e.getState()!==SourceState.READY){t=!1;break}return t}getImage(e,t,r,s){if(!this.allSourcesReady_())return null;const a=this.updateFrameState_(e,t,s);if(this.requestedFrameState_=a,this.renderedImageCanvas_){const r=this.renderedImageCanvas_.getResolution(),s=this.renderedImageCanvas_.getExtent();t===r&&equals(e,s)||(this.renderedImageCanvas_=null)}return this.renderedImageCanvas_&&this.getRevision()===this.renderedRevision_||this.processSources_(),a.tileQueue.loadMoreTiles(16,16),a.animate&&requestAnimationFrame(this.changed.bind(this)),this.renderedImageCanvas_}processSources_(){const e=this.requestedFrameState_,t=this.layers_.length,r=new Array(t);for(let s=0;s<t;++s){e.layerIndex=s;const t=getImageData(this.layers_[s],e);if(!t)return;r[s]=t}const s={};this.dispatchEvent(new RasterSourceEvent(RasterEventType.BEFOREOPERATIONS,e,s)),this.processor_.process(r,s,this.onWorkerComplete_.bind(this,e))}onWorkerComplete_(e,t,r,s){if(t||!r)return;const a=e.extent,n=e.viewState.resolution;if(n!==this.requestedFrameState_.viewState.resolution||!equals(a,this.requestedFrameState_.extent))return;let i;if(this.renderedImageCanvas_)i=this.renderedImageCanvas_.getImage().getContext("2d");else{const e=Math.round(getWidth(a)/n),t=Math.round(getHeight(a)/n);i=createCanvasContext2D(e,t),this.renderedImageCanvas_=new ImageCanvas(a,n,1,i.canvas)}i.putImageData(r,0,0),this.changed(),this.renderedRevision_=this.getRevision(),this.dispatchEvent(new RasterSourceEvent(RasterEventType.AFTEROPERATIONS,e,s)),e.animate&&requestAnimationFrame(this.changed.bind(this))}disposeInternal(){this.processor_&&this.processor_.dispose(),super.disposeInternal()}}RasterSource.prototype.dispose;let sharedContext=null;function getImageData(e,t){const r=e.getRenderer();if(!r)throw new Error("Unsupported layer type: "+e);if(!r.prepareFrame(t))return null;const s=t.size[0],a=t.size[1];if(0===s||0===a)return null;const n=r.renderFrame(t,null);let i;if(n&&(i=n.firstElementChild),!(i instanceof HTMLCanvasElement))throw new Error("Unsupported rendered element: "+i);if(i.width===s&&i.height===a){return i.getContext("2d").getImageData(0,0,s,a)}if(sharedContext){const e=sharedContext.canvas;e.width!==s||e.height!==a?sharedContext=createCanvasContext2D(s,a):sharedContext.clearRect(0,0,s,a)}else sharedContext=createCanvasContext2D(s,a);return sharedContext.drawImage(i,0,0,s,a),sharedContext.getImageData(0,0,s,a)}function getLayerStatesArray(e){return e.map((function(e){return e.getLayerState()}))}function createLayers(e){const t=e.length,r=new Array(t);for(let s=0;s<t;++s)r[s]=createLayer(e[s]);return r}function createLayer(e){let t;return e instanceof Source?e instanceof TileSource?t=new TileLayer({source:e}):e instanceof ImageSource&&(t=new ImageLayer({source:e})):t=e,t}export default RasterSource;
//# sourceMappingURL=/sm/baf2802da02ad96d1cb75c64db73912311017f35243e489891a0ceecb678a89b.map