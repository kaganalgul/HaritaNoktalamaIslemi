/**
 * Minified by jsDelivr using Terser v5.10.0.
 * Original file: /npm/ol@6.12.0/src/source/ImageWMS.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{DEFAULT_WMS_VERSION}from"./common.js";import EventType from"../events/EventType.js";import ImageSource,{defaultImageLoadFunction}from"./Image.js";import ImageWrapper from"../Image.js";import WMSServerType from"./WMSServerType.js";import{appendParams}from"../uri.js";import{assert}from"../asserts.js";import{assign}from"../obj.js";import{calculateSourceResolution}from"../reproj.js";import{ceil,floor,round}from"../math.js";import{compareVersions}from"../string.js";import{containsExtent,getCenter,getForViewAndSize,getHeight,getWidth}from"../extent.js";import{get as getProjection,transform}from"../proj.js";const DECIMALS=4,GETFEATUREINFO_IMAGE_SIZE=[101,101];class ImageWMS extends ImageSource{constructor(e){const t=e||{};let i=void 0===t.imageSmoothing||t.imageSmoothing;void 0!==t.interpolate&&(i=t.interpolate),super({attributions:t.attributions,interpolate:i,projection:t.projection,resolutions:t.resolutions}),this.crossOrigin_=void 0!==t.crossOrigin?t.crossOrigin:null,this.url_=t.url,this.imageLoadFunction_=void 0!==t.imageLoadFunction?t.imageLoadFunction:defaultImageLoadFunction,this.params_=t.params||{},this.v13_=!0,this.updateV13_(),this.serverType_=t.serverType,this.hidpi_=void 0===t.hidpi||t.hidpi,this.image_=null,this.imageSize_=[0,0],this.renderedRevision_=0,this.ratio_=void 0!==t.ratio?t.ratio:1.5}getFeatureInfoUrl(e,t,i,r){if(void 0===this.url_)return;const s=getProjection(i),o=this.getProjection();o&&o!==s&&(t=calculateSourceResolution(o,s,e,t),e=transform(e,s,o));const n=getForViewAndSize(e,t,0,GETFEATUREINFO_IMAGE_SIZE),a={SERVICE:"WMS",VERSION:DEFAULT_WMS_VERSION,REQUEST:"GetFeatureInfo",FORMAT:"image/png",TRANSPARENT:!0,QUERY_LAYERS:this.params_.LAYERS};assign(a,this.params_,r);const g=floor((e[0]-n[0])/t,4),h=floor((n[3]-e[1])/t,4);return a[this.v13_?"I":"X"]=g,a[this.v13_?"J":"Y"]=h,this.getRequestUrl_(n,GETFEATUREINFO_IMAGE_SIZE,1,o||s,a)}getLegendUrl(e,t){if(void 0===this.url_)return;const i={SERVICE:"WMS",VERSION:DEFAULT_WMS_VERSION,REQUEST:"GetLegendGraphic",FORMAT:"image/png"};if(void 0===t||void 0===t.LAYER){const e=this.params_.LAYERS;if(!(!Array.isArray(e)||1===e.length))return;i.LAYER=e}if(void 0!==e){const t=this.getProjection()?this.getProjection().getMetersPerUnit():1,r=28e-5;i.SCALE=e*t/r}return assign(i,t),appendParams(this.url_,i)}getParams(){return this.params_}getImageInternal(e,t,i,r){if(void 0===this.url_)return null;t=this.findNearestResolution(t),1==i||this.hidpi_&&void 0!==this.serverType_||(i=1);const s=t/i,o=getCenter(e),n=ceil(getWidth(e)/s,4),a=ceil(getHeight(e)/s,4),g=getForViewAndSize(o,s,0,[n,a]),h=ceil(this.ratio_*getWidth(e)/s,4),m=ceil(this.ratio_*getHeight(e)/s,4),_=getForViewAndSize(o,s,0,[h,m]),S=this.image_;if(S&&this.renderedRevision_==this.getRevision()&&S.getResolution()==t&&S.getPixelRatio()==i&&containsExtent(S.getExtent(),g))return S;const u={SERVICE:"WMS",VERSION:DEFAULT_WMS_VERSION,REQUEST:"GetMap",FORMAT:"image/png",TRANSPARENT:!0};assign(u,this.params_),this.imageSize_[0]=round(getWidth(_)/s,4),this.imageSize_[1]=round(getHeight(_)/s,4);const p=this.getRequestUrl_(_,this.imageSize_,i,r,u);return this.image_=new ImageWrapper(_,t,i,p,this.crossOrigin_,this.imageLoadFunction_),this.renderedRevision_=this.getRevision(),this.image_.addEventListener(EventType.CHANGE,this.handleImageChange.bind(this)),this.image_}getImageLoadFunction(){return this.imageLoadFunction_}getRequestUrl_(e,t,i,r,s){if(assert(void 0!==this.url_,9),s[this.v13_?"CRS":"SRS"]=r.getCode(),"STYLES"in this.params_||(s.STYLES=""),1!=i)switch(this.serverType_){case WMSServerType.GEOSERVER:const e=90*i+.5|0;"FORMAT_OPTIONS"in s?s.FORMAT_OPTIONS+=";dpi:"+e:s.FORMAT_OPTIONS="dpi:"+e;break;case WMSServerType.MAPSERVER:s.MAP_RESOLUTION=90*i;break;case WMSServerType.CARMENTA_SERVER:case WMSServerType.QGIS:s.DPI=90*i;break;default:assert(!1,8)}s.WIDTH=t[0],s.HEIGHT=t[1];const o=r.getAxisOrientation();let n;return n=this.v13_&&"ne"==o.substr(0,2)?[e[1],e[0],e[3],e[2]]:e,s.BBOX=n.join(","),appendParams(this.url_,s)}getUrl(){return this.url_}setImageLoadFunction(e){this.image_=null,this.imageLoadFunction_=e,this.changed()}setUrl(e){e!=this.url_&&(this.url_=e,this.image_=null,this.changed())}updateParams(e){assign(this.params_,e),this.updateV13_(),this.image_=null,this.changed()}updateV13_(){const e=this.params_.VERSION||DEFAULT_WMS_VERSION;this.v13_=compareVersions(e,"1.3")>=0}}export default ImageWMS;
//# sourceMappingURL=/sm/74e2eeb853ec1493d133b1614f700254f721ed52e18ece2fe4f2c87033fe5895.map