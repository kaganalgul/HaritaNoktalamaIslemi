/**
 * Minified by jsDelivr using Terser v5.10.0.
 * Original file: /npm/ol@6.12.0/src/reproj/Tile.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{ERROR_THRESHOLD}from"./common.js";import EventType from"../events/EventType.js";import Tile from"../Tile.js";import TileState from"../TileState.js";import Triangulation from"./Triangulation.js";import{calculateSourceExtentResolution,render as renderReprojected}from"../reproj.js";import{clamp}from"../math.js";import{getArea,getIntersection}from"../extent.js";import{listen,unlistenByKey}from"../events.js";class ReprojTile extends Tile{constructor(t,e,i,s,r,o,n,l,a,h,c,u){super(r,TileState.IDLE,{interpolate:!!u}),this.renderEdges_=void 0!==c&&c,this.pixelRatio_=n,this.gutter_=l,this.canvas_=null,this.sourceTileGrid_=e,this.targetTileGrid_=s,this.wrappedTileCoord_=o||r,this.sourceTiles_=[],this.sourcesListenerKeys_=null,this.sourceZ_=0;const T=s.getTileCoordExtent(this.wrappedTileCoord_),g=this.targetTileGrid_.getExtent();let _=this.sourceTileGrid_.getExtent();const d=g?getIntersection(T,g):T;if(0===getArea(d))return void(this.state=TileState.EMPTY);const p=t.getExtent();p&&(_=_?getIntersection(_,p):p);const E=s.getResolution(this.wrappedTileCoord_[0]),m=calculateSourceExtentResolution(t,i,d,E);if(!isFinite(m)||m<=0)return void(this.state=TileState.EMPTY);const S=void 0!==h?h:ERROR_THRESHOLD;if(this.triangulation_=new Triangulation(t,i,d,_,m*S,E),0===this.triangulation_.getTriangles().length)return void(this.state=TileState.EMPTY);this.sourceZ_=e.getZForResolution(m);let f=this.triangulation_.calculateSourceExtent();if(_&&(t.canWrapX()?(f[1]=clamp(f[1],_[1],_[3]),f[3]=clamp(f[3],_[1],_[3])):f=getIntersection(f,_)),getArea(f)){const t=e.getTileRangeForExtentAndZ(f,this.sourceZ_);for(let e=t.minX;e<=t.maxX;e++)for(let i=t.minY;i<=t.maxY;i++){const t=a(this.sourceZ_,e,i,n);t&&this.sourceTiles_.push(t)}0===this.sourceTiles_.length&&(this.state=TileState.EMPTY)}else this.state=TileState.EMPTY}getImage(){return this.canvas_}reproject_(){const t=[];if(this.sourceTiles_.forEach(function(e,i,s){e&&e.getState()==TileState.LOADED&&t.push({extent:this.sourceTileGrid_.getTileCoordExtent(e.tileCoord),image:e.getImage()})}.bind(this)),this.sourceTiles_.length=0,0===t.length)this.state=TileState.ERROR;else{const e=this.wrappedTileCoord_[0],i=this.targetTileGrid_.getTileSize(e),s="number"==typeof i?i:i[0],r="number"==typeof i?i:i[1],o=this.targetTileGrid_.getResolution(e),n=this.sourceTileGrid_.getResolution(this.sourceZ_),l=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_);this.canvas_=renderReprojected(s,r,this.pixelRatio_,n,this.sourceTileGrid_.getExtent(),o,l,this.triangulation_,t,this.gutter_,this.renderEdges_,this.interpolate),this.state=TileState.LOADED}this.changed()}load(){if(this.state==TileState.IDLE){this.state=TileState.LOADING,this.changed();let t=0;this.sourcesListenerKeys_=[],this.sourceTiles_.forEach(function(e,i,s){const r=e.getState();if(r==TileState.IDLE||r==TileState.LOADING){t++;const i=listen(e,EventType.CHANGE,(function(s){const r=e.getState();r!=TileState.LOADED&&r!=TileState.ERROR&&r!=TileState.EMPTY||(unlistenByKey(i),t--,0===t&&(this.unlistenSources_(),this.reproject_()))}),this);this.sourcesListenerKeys_.push(i)}}.bind(this)),0===t?setTimeout(this.reproject_.bind(this),0):this.sourceTiles_.forEach((function(t,e,i){t.getState()==TileState.IDLE&&t.load()}))}}unlistenSources_(){this.sourcesListenerKeys_.forEach(unlistenByKey),this.sourcesListenerKeys_=null}}export default ReprojTile;
//# sourceMappingURL=/sm/e5e9d5ae4539107fffb7a8eb05a3c9484477fc90d48cb57d8965bed69134da82.map